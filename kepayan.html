<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Warehouse Management System</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pICvZonb6pj+/U6h8S86YtDj2OmyH9DlK6tm+VQf+U4km/DomZ+ZSSMwL8vqbsOYb7jz0VJo4zQ9ejO9L6LQDw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <style>
    /* Basic Styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      background-size: cover;
      background-position: center;
      transition: background-color 0.3s ease;
      font-size: 16px; /* Base font size */
    }
    
    header {
      background-color: rgba(0, 57, 116, 0.9);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    nav {
      background-color: rgba(0, 75, 153, 0.9);
      color: white;
      padding: 10px 20px;
    }
    
    .nav-menu {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      margin: 0;
      padding: 0;
    }
    
    .nav-menu li {
      margin-right: 20px;
      position: relative;
    }
    
    .nav-menu li a {
      color: white;
      text-decoration: none;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      transition: background-color 0.3s ease, transform 0.3s ease;
      border-radius: 4px;
    }
    
    .nav-menu li a:hover {
      background-color: #002a63;
      transform: translateY(-2px);
    }
    
    /* Dropdown Menu */
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #002a63;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      top: 40px;
      left: 0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .dropdown-content a {
      color: #333333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background-color 0.3s ease;
    }
    
    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }
    
    .dropdown:hover .dropdown-content {
      display: block;
    }
    
    main {
      padding: 20px;
    }
    
    h1, h2, h3 {
      margin: 0 0 15px 0;
      color: #333333;
    }
    
    /* Input Group */
    .input-group {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      position: relative;
    }
    
    .input-group i {
      margin-right: 10px;
      color: #333333;
      position: absolute;
      left: 15px;
      z-index: 2;
    }
    
    input, select, button {
      width: 100%;
      padding: 10px 15px;
      padding-left: 40px; /* Space for icon */
      margin-bottom: 15px;
      border: 1px solid #cccccc;
      border-radius: 25px;
      box-sizing: border-box;
      outline: none;
      transition: all 0.3s ease;
      font-size: 1em;
    }
    
    input:focus, select:focus, button:focus {
      border-color: #003974;
      box-shadow: 0 0 5px rgba(0, 57, 116, 0.5);
    }
    
    button {
      background-color: #003974;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1em;
      border-radius: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    
    button:hover {
      background-color: #002a63;
      transform: translateY(-2px);
    }
    
    /* Checkbox Container */
    .checkbox-container {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .checkbox-container input {
      margin-right: 10px;
    }
    
    /* Error Messages */
    .error-message {
      color: red;
      margin-top: -10px;
      margin-bottom: 10px;
    }
    
    /* Responsive Tables */
    .table-responsive {
      display: block !important;
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    th, td {
      text-align: left;
      padding: 12px 15px;
      border-bottom: 1px solid #dddddd;
    }
    
    th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    /* Hide on Mobile */
    .hide-on-mobile {
      display: table-cell !important;
    }
    
    @media (max-width: 480px) {
      /* Adjust form inputs and buttons on small screens */
      input, select, button {
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 15px;
        font-size: 1em;
      }
      
      .modal-content {
        width: 90%;
        margin: 20% auto;
      }
      
      header, nav, main {
        padding: 10px;
      }
      
      header h2 {
        font-size: 1.2em;
      }
    }
    
    /* Modal Styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto; /* 5% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      width: 50%; /* Could be more or less, depending on screen size */
      border-radius: 8px;
      position: relative;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .close {
      color: #aaaaaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }
    
    /* Welcome Message */
    #welcome-message {
      margin-right: 15px;
      font-size: 1em;
    }
    
    /* Loading Indicator */
    #loading-indicator {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 2000;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      color: #003974;
    }
    
    /* Search Bar Styles */
    #search-container {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    
    #search-input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #cccccc;
      border-radius: 25px;
      outline: none;
      transition: all 0.3s ease;
      font-size: 1em;
    }
    
    #search-input:focus {
      border-color: #003974;
      box-shadow: 0 0 5px rgba(0, 57, 116, 0.5);
    }
    
    /* Show/Hide Password Toggle */
    .toggle-password {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #333333;
      transition: color 0.3s ease;
    }
    
    .toggle-password:hover {
      color: #003974;
    }
    
    /* Error State for Select */
    .select-error {
      border-color: red !important;
      box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
    }
    
    /* Remember Me 部分的更新代码 */
    .checkbox-container {
      margin-bottom: 25px;
      display: flex;
      align-items: center;
    }
    
    .checkbox-container input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin: 0;
      padding: 0;
      cursor: pointer;
      accent-color: #003974;
    }
    
    .checkbox-container label {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Loading Indicator -->
  <div id="loading-indicator">
    <i class="fas fa-spinner fa-spin fa-3x"></i>
  </div>

  <!-- Authentication Container -->
  <div id="auth-container">
    <!-- Login Form -->
    <div id="login-form" style="max-width: 400px; margin: 50px auto; padding: 40px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <!-- Logo and Title -->
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #003974; font-size: 2.5em; margin-bottom: 10px;">
          <i class="fas fa-box-open" style="color: #003974;"></i> SmartProfits
        </h1>
        <p style="color: #666; font-size: 1.1em;">Stock Management System</p>
      </div>

      <!-- Login Form -->
      <div class="input-group" style="margin-bottom: 25px;">
        <i class="fas fa-envelope" style="color: #003974;"></i>
        <input type="email" id="login-email" placeholder="Enter Email" style="background: #f8f9fa; border: 2px solid #e9ecef;" required>
      </div>

      <div class="input-group" style="margin-bottom: 25px;">
        <i class="fas fa-lock" style="color: #003974;"></i>
        <input type="password" id="login-password" placeholder="Enter Password" style="background: #f8f9fa; border: 2px solid #e9ecef;" required>
        <i class="fas fa-eye toggle-password" id="toggle-password" style="color: #003974; cursor: pointer;"></i>
      </div>

      <!-- Remember Me -->
      <div class="checkbox-container" style="margin-bottom: 25px; display: flex; align-items: center;">
        <div style="display: flex; align-items: center;">
          <input type="checkbox" id="remember-me" style="margin: 0; width: auto; height: auto;">
          <label for="remember-me" style="color: #666; margin-left: 8px;">Remember Me</label>
        </div>
        <div style="margin-left: auto;">
          <a href="#" id="forgot-password" style="color: #003974; text-decoration: none; font-weight: 500;">Forgot Password?</a>
        </div>
      </div>

      <!-- Login Button -->
      <button id="login-button" style="background: linear-gradient(135deg, #003974, #002a63); margin-bottom: 20px; height: 50px; font-size: 1.1em; letter-spacing: 1px;">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>

      <!-- Links -->
      <div style="text-align: center; margin-top: 20px;">
        <p style="color: #666;">
          Don't have an account? 
          <a href="#" id="show-register" style="color: #003974; text-decoration: none; font-weight: 500;">Register</a>
        </p>
      </div>

      <!-- Error Message -->
      <p id="login-error" class="error-message" style="text-align: center; color: #dc3545; margin-top: 15px;"></p>
    </div>
    
    <!-- Register Form -->
    <div id="register-form" style="display: none; max-width: 400px; margin: 50px auto; padding: 40px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #003974; font-size: 2.5em; margin-bottom: 10px;">
          <i class="fas fa-user-plus" style="color: #003974;"></i> Register
        </h1>
        <p style="color: #666; font-size: 1.1em;">Create your account</p>
      </div>

      <div class="input-group" style="margin-bottom: 25px;">
        <i class="fas fa-user" style="color: #003974;"></i>
        <input 
          type="text" 
          id="register-name" 
          placeholder="Enter Name" 
          maxlength="12" 
          style="background: #f8f9fa; border: 2px solid #e9ecef;" 
          required
        >
      </div>

      <div class="input-group" style="margin-bottom: 25px;">
        <i class="fas fa-envelope" style="color: #003974;"></i>
        <input type="email" id="register-email" placeholder="Enter Email" style="background: #f8f9fa; border: 2px solid #e9ecef;" required>
      </div>

      <div class="input-group" style="margin-bottom: 25px;">
        <i class="fas fa-lock" style="color: #003974;"></i>
        <input type="password" id="register-password" placeholder="Enter Password" style="background: #f8f9fa; border: 2px solid #e9ecef;" required>
      </div>

      <button id="register-button" style="background: linear-gradient(135deg, #003974, #002a63); margin-bottom: 20px; height: 50px; font-size: 1.1em; letter-spacing: 1px;">
        <i class="fas fa-user-plus"></i> Register
      </button>

      <div style="text-align: center;">
        <p style="color: #666;">
          Already have an account? 
          <a href="#" id="show-login" style="color: #003974; text-decoration: none; font-weight: 500;">Login</a>
        </p>
      </div>

      <p id="register-error" class="error-message" style="text-align: center; color: #dc3545; margin-top: 15px;"></p>
    </div>
  </div>

  <!-- Main Application Container -->
  <div id="app-container" style="display: none;">
    <header>
      <h1 style="color: ghostwhite;">SmartProfits Stock System</h1>
      <div id="user-info">
        <span id="welcome-message"></span>
        <button id="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </header>
    
    <nav>
      <ul class="nav-menu" id="nav-menu">
        <li><a href="#" id="nav-inventory"><i class="fas fa-boxes"></i> Inventory List</a></li>
        <!-- Stock In Dropdown Menu -->
        <li class="dropdown">
          <a href="#"><i class="fas fa-download"></i> Stock In</a>
          <div class="dropdown-content">
            <a href="#" id="nav-stock-in-office">Office</a>
            <a href="#" id="nav-stock-in-kepayan-seafood">Kepayan - Seafood</a>
            <a href="#" id="nav-stock-in-kepayan-packaged">Kepayan - Packaged Food</a>
          </div>
        </li>
        <!-- Stock Out -->
        <li><a href="#" id="nav-stock-out"><i class="fas fa-box-open"></i> Stock Out</a></li>
        <!-- Transaction Records -->
        <li><a href="#" id="nav-transaction-records"><i class="fas fa-exchange-alt"></i> Transaction Records</a></li>
      </ul>
    </nav>
    
    <main>
      <!-- Inventory List Section -->
      <section id="inventory-list-section">
        <h3>Inventory List</h3>
        
        <!-- Search Bar -->
        <div id="search-container">
          <input type="text" id="search-input" placeholder="Search by Product Name">
        </div>
        
        <!-- Responsive Table -->
        <div class="table-responsive">
          <table id="inventory-table">
            <thead>
              <tr>
                <th>Product Name</th>
                <th class="hide-on-mobile">Category</th>
                <th>Quantity</th>
                <th class="hide-on-mobile">Unit</th>
                <th class="hide-on-mobile">Expiry Date</th>
                <th class="hide-on-mobile">Location</th>
                <th class="hide-on-mobile">Last Modified Time</th>
                <th class="hide-on-mobile">Modified By</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Items will be dynamically populated -->
            </tbody>
          </table>
        </div>
        
        <!-- Mobile Card Layout -->
        <div id="inventory-cards" class="cards-container" style="display: none;">
          <!-- Inventory Item Cards Will Be Dynamically Populated -->
        </div>
        <p id="inventory-message"></p>
      </section>
      
      <!-- Stock In Section - Office -->
      <section id="stock-in-office-section" style="display: none;">
        <h3>Stock In - Office</h3>
        <label for="stock-in-office-name">Product Name</label>
        <input type="text" id="stock-in-office-name" placeholder="Product Name" required>
        
        <label for="stock-in-office-quantity">Quantity</label>
        <input type="number" id="stock-in-office-quantity" placeholder="Quantity" required>
        
        <label for="stock-in-office-unit">Unit</label>
        <input type="text" id="stock-in-office-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
        
        <label for="stock-in-office-expired-date">Expiry Date (Optional)</label>
        <input type="date" id="stock-in-office-expired-date" placeholder="Expiry Date (Optional)">
        
        <label for="stock-in-office-location">Location</label>
        <select id="stock-in-office-location" required>
          <option value="office">Office</option>
        </select>
        
        <button id="stock-in-office-button"><i class="fas fa-download"></i> Add Stock In - Office</button>
        <p id="stock-in-office-error" class="error-message"></p>
      </section>
      
      <!-- Stock In Section - Kepayan - Seafood -->
      <section id="stock-in-kepayan-seafood-section" style="display: none;">
        <h3>Stock In - Kepayan - Seafood</h3>
        <label for="stock-in-kepayan-seafood-name">Product Name</label>
        <input type="text" id="stock-in-kepayan-seafood-name" placeholder="Product Name" required>
        
        <label for="stock-in-kepayan-seafood-category">Category</label>
        <select id="stock-in-kepayan-seafood-category" required>
          <option value="">Select Category</option>
          <option value="Seafood">Seafood</option>
        </select>
        
        <label for="stock-in-kepayan-seafood-quantity">Quantity</label>
        <input type="number" id="stock-in-kepayan-seafood-quantity" placeholder="Quantity" required>
        
        <label for="stock-in-kepayan-seafood-unit">Unit</label>
        <input type="text" id="stock-in-kepayan-seafood-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
        
        <label for="stock-in-kepayan-seafood-expired-date">Expiry Date (Optional)</label>
        <input type="date" id="stock-in-kepayan-seafood-expired-date" placeholder="Expiry Date (Optional)">
        
        <label for="stock-in-kepayan-seafood-location">Location</label>
        <select id="stock-in-kepayan-seafood-location" required>
          <option value="kepayan">Kepayan</option>
        </select>
        
        <button id="stock-in-kepayan-seafood-button"><i class="fas fa-download"></i> Add Stock In - Kepayan - Seafood</button>
        <p id="stock-in-kepayan-seafood-error" class="error-message"></p>
      </section>
      
      <!-- Stock In Section - Kepayan - Packaged Food -->
      <section id="stock-in-kepayan-packaged-section" style="display: none;">
        <h3>Stock In - Kepayan - Packaged Food</h3>
        <label for="stock-in-kepayan-packaged-name">Product Name</label>
        <input type="text" id="stock-in-kepayan-packaged-name" placeholder="Product Name" required>
        
        <label for="stock-in-kepayan-packaged-category">Category</label>
        <select id="stock-in-kepayan-packaged-category" required>
          <option value="">Select Category</option>
          <option value="Packaged Food">Packaged Food</option>
        </select>
        
        <label for="stock-in-kepayan-packaged-quantity">Quantity</label>
        <input type="number" id="stock-in-kepayan-packaged-quantity" placeholder="Quantity" required>
        
        <label for="stock-in-kepayan-packaged-unit">Unit</label>
        <input type="text" id="stock-in-kepayan-packaged-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
        
        <label for="stock-in-kepayan-packaged-expired-date">Expiry Date (Optional)</label>
        <input type="date" id="stock-in-kepayan-packaged-expired-date" placeholder="Expiry Date (Optional)">
        
        <label for="stock-in-kepayan-packaged-location">Location</label>
        <select id="stock-in-kepayan-packaged-location" required>
          <option value="kepayan">Kepayan</option>
        </select>
        
        <button id="stock-in-kepayan-packaged-button"><i class="fas fa-download"></i> Add Stock In - Kepayan - Packaged Food</button>
        <p id="stock-in-kepayan-packaged-error" class="error-message"></p>
      </section>
      
      <!-- Transaction Records Section -->
      <section id="transaction-records-section" style="display: none;">
        <h3>Transaction Records</h3>
        
        <!-- Transaction Records Responsive Table -->
        <div class="table-responsive">
          <table id="transaction-records-table">
            <thead>
              <tr>
                <th>Product Name</th>
                <th class="hide-on-mobile">Category</th>
                <th>Quantity</th>
                <th class="hide-on-mobile">Unit</th>
                <th class="hide-on-mobile">Expiry Date</th>
                <th>Transaction Time</th> <!-- Added Stock Out Time -->
                <th>Modified By</th>
                <th>Comment</th>
              </tr>
            </thead>
            <tbody>
              <!-- Transaction Records Will Be Dynamically Populated -->
            </tbody>
          </table>
        </div>
        
        <!-- Mobile Card Layout for Transaction Records (Displays All Data) -->
        <div id="transaction-records-cards" class="cards-container" style="display: none;">
          <!-- Transaction Records Cards Will Be Dynamically Populated -->
        </div>
        <p id="transaction-records-message"></p>
      </section>
      
      <!-- Stock Out Section -->
      <section id="stock-out-section" style="display: none;">
        <h3>Stock Out</h3>
        
        <!-- Search and Filter -->
        <div id="stock-out-search-container">
          <input type="text" id="stock-out-search" placeholder="Search Products">
          <select id="stock-out-location-filter">
            <option value="all">All Locations</option>
            <option value="office">Office</option>
            <option value="kepayan">Kepayan</option>
          </select>
        </div>
        
        <!-- Table for selecting items -->
        <div class="table-responsive">
          <table id="stock-out-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all-items"></th>
                <th>Product Name</th>
                <th>Category</th>
                <th>Available Quantity</th>
                <th>Unit</th>
                <th>Location</th>
                <th>Stock Out Quantity</th>
              </tr>
            </thead>
            <tbody>
              <!-- Items will be dynamically populated -->
            </tbody>
          </table>
        </div>
        
        <!-- Batch Stock Out Form -->
        <div id="batch-stock-out-form">
          <label for="stock-out-comment">Comment:</label>
          <select id="stock-out-comment" required>
            <option value="" disabled selected>Select Comment</option>
            <option value="Tamoi">Tamoi</option>
            <option value="KTSP">KTSP</option>
            <option value="Ole-Ole(DALAM)">Ole-Ole(DALAM)</option>
            <option value="Ole-Ole(Luar)">Ole-Ole(Luar)</option>
            <option value="TOM">TOM</option>
            <option value="JKL">JKL</option>
            <option value="Wrapping">Wrapping</option>
            <option value="Left Luggage">Left Luggage</option>
            <option value="Wisma">Wisma</option>
          </select>

          <button id="batch-stock-out-button" disabled>
            <i class="fas fa-box-open"></i> Process Stock Out
          </button>
          <p id="batch-stock-out-error" class="error-message"></p>
        </div>
      </section>
    </main>
  </div>

  <!-- Edit Inventory Item Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Edit Inventory Item</h3>
      
      <label for="edit-item-name">Product Name</label>
      <input type="text" id="edit-item-name" placeholder="Product Name" required>
      
      <label for="edit-item-category">Category</label>
      <select id="edit-item-category" required>
        <option value="">Select Category</option>
        <option value="Packaged Food">Packaged Food</option>
        <option value="Seafood">Seafood</option>
      </select>
      
      <label for="edit-item-quantity">Quantity</label>
      <input type="number" id="edit-item-quantity" placeholder="Quantity" required>
      
      <label for="edit-item-unit">Unit</label>
      <input type="text" id="edit-item-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
      
      <label for="edit-item-expired-date">Expiry Date (Optional)</label>
      <input type="date" id="edit-item-expired-date">
      
      <label for="edit-item-location">Location</label>
      <select id="edit-item-location" required>
        <option value="">Select Location</option>
        <option value="office">Office</option>
        <option value="kepayan">Kepayan</option>
      </select>
      
      <button id="save-edit-button">Save Changes</button>
      <p id="edit-item-error" class="error-message"></p>
    </div>
  </div>

  <!-- Stock Out Modal -->
  <div id="stock-out-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Stock Out</h3>
      
      <label for="stock-out-quantity">Quantity to Stock Out</label>
      <input type="number" id="stock-out-quantity" placeholder="Quantity" required>
      
      <label for="stock-out-comment">Comment</label>
      <select id="stock-out-comment" required>
        <option value="" disabled selected>Select Comment</option>
        <option value="Tamoi">Tamoi</option>
        <option value="KTSP">KTSP</option>
        <option value="Ole-Ole(DALAM)">Ole-Ole(DALAM)</option>
        <option value="Ole-Ole(Luar)">Ole-Ole(Luar)</option>
        <option value="TOM">TOM</option>
        <option value="JKL">JKL</option>
        <option value="Wrapping">Wrapping</option>
        <option value="Left Luggage">Left Luggage</option>
        <option value="Wisma">Wisma</option>
      </select>
      
      <button id="confirm-stock-out-button"><i class="fas fa-check"></i> Confirm Stock Out</button>
      <p id="stock-out-error" class="error-message"></p>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAK5KVv9oln2qS5EfNzox1snM19wa83-o",
      authDomain: "smart-profits-stock.firebaseapp.com",
      databaseURL: "https://smart-profits-stock-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smart-profits-stock",
      storageBucket: "smart-profits-stock.firebasestorage.app",
      messagingSenderId: "1029424292465",
      appId: "1:1029424292465:web:6de46925db8818d462b1d0",
      measurementId: "G-R0K4Q7JTGE"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Get Page Elements
    const authContainer = document.getElementById('auth-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const loginButton = document.getElementById('login-button');
    const registerButton = document.getElementById('register-button');
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');

    const appContainer = document.getElementById('app-container');
    const logoutButton = document.getElementById('logout-button');
    const navInventory = document.getElementById('nav-inventory');
    const navStockInOffice = document.getElementById('nav-stock-in-office');
    const navStockInKepayanSeafood = document.getElementById('nav-stock-in-kepayan-seafood');
    const navStockInKepayanPackaged = document.getElementById('nav-stock-in-kepayan-packaged');
    const navTransactionRecords = document.getElementById('nav-transaction-records'); // Added
    const navStockOut = document.getElementById('nav-stock-out');
    const stockOutSection = document.getElementById('stock-out-section');
    const stockOutTable = document.getElementById('stock-out-table');
    const selectAllItems = document.getElementById('select-all-items');
    const batchStockOutButton = document.getElementById('batch-stock-out-button');
    const stockOutSearch = document.getElementById('stock-out-search');
    const stockOutLocationFilter = document.getElementById('stock-out-location-filter');

    const inventoryListSection = document.getElementById('inventory-list-section');
    const stockInOfficeSection = document.getElementById('stock-in-office-section');
    const stockInKepayanSeafoodSection = document.getElementById('stock-in-kepayan-seafood-section');
    const stockInKepayanPackagedSection = document.getElementById('stock-in-kepayan-packaged-section');
    const transactionRecordsSection = document.getElementById('transaction-records-section'); // Added

    // Stock In Buttons
    const stockInOfficeButton = document.getElementById('stock-in-office-button');
    const stockInKepayanSeafoodButton = document.getElementById('stock-in-kepayan-seafood-button');
    const stockInKepayanPackagedButton = document.getElementById('stock-in-kepayan-packaged-button');

    // Stock In Input Fields
    const stockInOfficeNameInput = document.getElementById('stock-in-office-name');
    const stockInOfficeQuantityInput = document.getElementById('stock-in-office-quantity');
    const stockInOfficeUnitInput = document.getElementById('stock-in-office-unit');
    const stockInOfficeExpiredDateInput = document.getElementById('stock-in-office-expired-date');
    const stockInOfficeLocationSelect = document.getElementById('stock-in-office-location');
    const stockInOfficeError = document.getElementById('stock-in-office-error');

    const stockInKepayanSeafoodNameInput = document.getElementById('stock-in-kepayan-seafood-name');
    const stockInKepayanSeafoodCategorySelect = document.getElementById('stock-in-kepayan-seafood-category');
    const stockInKepayanSeafoodQuantityInput = document.getElementById('stock-in-kepayan-seafood-quantity');
    const stockInKepayanSeafoodUnitInput = document.getElementById('stock-in-kepayan-seafood-unit');
    const stockInKepayanSeafoodExpiredDateInput = document.getElementById('stock-in-kepayan-seafood-expired-date');
    const stockInKepayanSeafoodLocationSelect = document.getElementById('stock-in-kepayan-seafood-location');
    const stockInKepayanSeafoodError = document.getElementById('stock-in-kepayan-seafood-error');

    const stockInKepayanPackagedNameInput = document.getElementById('stock-in-kepayan-packaged-name');
    const stockInKepayanPackagedCategorySelect = document.getElementById('stock-in-kepayan-packaged-category');
    const stockInKepayanPackagedQuantityInput = document.getElementById('stock-in-kepayan-packaged-quantity');
    const stockInKepayanPackagedUnitInput = document.getElementById('stock-in-kepayan-packaged-unit');
    const stockInKepayanPackagedExpiredDateInput = document.getElementById('stock-in-kepayan-packaged-expired-date');
    const stockInKepayanPackagedLocationSelect = document.getElementById('stock-in-kepayan-packaged-location');
    const stockInKepayanPackagedError = document.getElementById('stock-in-kepayan-packaged-error');

    const inventoryTableBody = document.querySelector('#inventory-table tbody');
    const inventoryMessage = document.getElementById('inventory-message');
    const inventoryCardsContainer = document.getElementById('inventory-cards');

    const transactionRecordsTableBody = document.querySelector('#transaction-records-table tbody'); // Added
    const transactionRecordsMessage = document.getElementById('transaction-records-message'); // Added

    const editModal = document.getElementById('edit-modal');
    const closeModalSpan = editModal.querySelector('.close');
    const editItemTypeSelect = document.getElementById('edit-item-type'); // Added
    const editItemNameInput = document.getElementById('edit-item-name');
    const editItemCategorySelect = document.getElementById('edit-item-category');
    const editItemQuantityInput = document.getElementById('edit-item-quantity');
    const editItemUnitInput = document.getElementById('edit-item-unit');
    const editItemExpiredDateInput = document.getElementById('edit-item-expired-date');
    const editItemLocationSelect = document.getElementById('edit-item-location');
    const saveEditButton = document.getElementById('save-edit-button');
    const editItemError = document.getElementById('edit-item-error');

    const stockOutModal = document.getElementById('stock-out-modal'); // Added
    const closeStockOutModalSpan = stockOutModal.querySelector('.close'); // Added
    const confirmStockOutButton = document.getElementById('confirm-stock-out-button'); // Added
    const stockOutQuantityInput = document.getElementById('stock-out-quantity'); // Added
    const stockOutCommentInput = document.getElementById('stock-out-comment'); // Changed to select
    const stockOutError = document.getElementById('stock-out-error'); // Added

    const loadingIndicator = document.getElementById('loading-indicator');

    // User Info Display Element
    const welcomeMessage = document.getElementById('welcome-message');

    let currentEditItemId = null; // Current Editing Inventory Item ID
    let currentStockOutItemId = null; // Current Stock Out Inventory Item ID // Added
    let userRole = null; // Current User Role

    /**
     * Formats an ISO 8601 date string to "dd-mm-yyyy (hh.mmam/pm)"
     * @param {string} isoString - The ISO 8601 date string.
     * @returns {string} - The formatted date string.
     */
    function formatDateTime(isoString) {
        const date = new Date(isoString);
        if (isNaN(date)) return 'Invalid Date';

        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
        const year = date.getFullYear();

        let hours = date.getHours();
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        const formattedTime = `${String(hours).padStart(2, '0')}.${minutes}${ampm}`;

        return `${day}-${month}-${year} (${formattedTime})`;
    }

    // Get Inventory Paths Based on User Role
    function getInventoryPaths() {
      let paths = [];
      if (userRole === 'admin' || userRole === 'adminv') {
        paths = ['inventory/office', 'inventory/kepayan'];
      } else if (userRole === 'admino') {
        paths = ['inventory/office'];
      } else if (userRole === 'admink') {
        paths = ['inventory/kepayan'];
      } else {
        // Regular users might only have view permissions
        paths = ['inventory'];
      }
      return paths;
    }

    // Show/Hide Register Form
    showRegisterLink.addEventListener('click', (e) => {
      e.preventDefault();
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
    });

    showLoginLink.addEventListener('click', (e) => {
      e.preventDefault();
      registerForm.style.display = 'none';
      loginForm.style.display = 'block';
    });

    // Register Functionality
    registerButton.addEventListener('click', (e) => {
      e.preventDefault();
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value.trim();

      if (name === '' || email === '' || password === '') {
        registerError.textContent = 'Please fill in all fields.';
        return;
      }

      showLoading();

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // Registration successful, set display name
          return userCredential.user.updateProfile({
            displayName: name
          });
        })
        .then(() => {
          // Save user info to database with default role "user"
          const user = auth.currentUser;
          if (user) {
            db.ref('users/' + user.uid).set({
              name: user.displayName,
              email: user.email,
              role: 'user' // Default role is "user"
            });
          }
          registerError.textContent = '';
          registerForm.reset();
        })
        .catch((error) => {
          console.error('Registration Error:', error);
          registerError.textContent = error.message;
        })
        .finally(() => {
          hideLoading();
        });
    });

    // Login Functionality (Including "Remember Me")
    loginButton.addEventListener('click', (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const rememberMe = document.getElementById('remember-me').checked;

      if (email === '' || password === '') {
        loginError.textContent = 'Please fill in all fields.';
        return;
      }

      showLoading();

      // Set persistence based on "Remember Me"
      const persistence = rememberMe
        ? firebase.auth.Auth.Persistence.LOCAL
        : firebase.auth.Auth.Persistence.SESSION;

      auth.setPersistence(persistence)
        .then(() => {
          return auth.signInWithEmailAndPassword(email, password);
        })
        .then((userCredential) => {
          // Login successful
          loginError.textContent = '';
          loginForm.reset();
        })
        .catch((error) => {
          console.error('Login Error:', error);
          loginError.textContent = error.message;
        })
        .finally(() => {
          hideLoading();
        });
    });

    // Listen for Authentication State Changes
    auth.onAuthStateChanged((user) => {
      if (user) {
        // User is logged in, get user role
        authContainer.style.display = 'none';
        appContainer.style.display = 'block';
        document.body.classList.add('logged-in'); // Add class to change background
        getUserRole(user.uid);

        // Display welcome message
        const displayName = user.displayName || 'User';
        welcomeMessage.textContent = `Welcome, ${displayName} (${userRole ? userRole : 'Loading...'})`;
      } else {
        // User is not logged in, show login/register
        authContainer.style.display = 'block';
        appContainer.style.display = 'none';
        document.body.classList.remove('logged-in'); // Remove class to restore background
        inventoryTableBody.innerHTML = '';
        inventoryCardsContainer.innerHTML = '';
        inventoryMessage.textContent = '';
        transactionRecordsTableBody.innerHTML = ''; // Clear transaction records table
        transactionRecordsMessage.textContent = '';
        welcomeMessage.textContent = '';
      }
    });

    // Get User Role from Database
    function getUserRole(uid) {
      db.ref('users/' + uid + '/role').once('value')
        .then((snapshot) => {
          userRole = snapshot.val();
          adjustUIBasedOnRole();
          loadInventoryForRole(); // Load inventory based on role
        })
        .then(() => {
          // Update welcome message
          const user = auth.currentUser;
          const displayName = user.displayName || 'User';
          welcomeMessage.textContent = `Welcome, ${displayName} (${userRole})`;
        })
        .catch((error) => {
          console.error('Failed to get user role:', error);
        });
    }

    // Adjust UI Based on User Role
    function adjustUIBasedOnRole() {
      // Reset all navigation items' display
      document.querySelectorAll('.nav-menu .dropdown, #nav-inventory').forEach(element => {
        element.style.display = 'block';
      });

      // Hide functionalities based on role
      switch(userRole) {
        case 'admin':
          // Admin: Access to all functionalities, no need to hide anything
          break;
        case 'adminv':
          // Adminv: Can only view inventory, hide stock in functionalities
          document.querySelectorAll('.nav-menu .dropdown').forEach(dropdown => {
            dropdown.style.display = 'none';
          });
          break;
        case 'admino':
          // Admino: Can only manage office inventory
          document.getElementById('nav-stock-in-kepayan-seafood').style.display = 'none';
          document.getElementById('nav-stock-in-kepayan-packaged').style.display = 'none';
          break;
        case 'admink':
          // Admink: Can only manage kepayan inventory
          document.getElementById('nav-stock-in-office').style.display = 'none';
          break;
        case 'user':
          // User: Regular user, hide all functionalities including inventory list
          document.querySelectorAll('.nav-menu .dropdown, #nav-inventory').forEach(element => {
            element.style.display = 'none';
          });
          break;
        default:
          // Undefined role, hide all functionalities
          document.querySelectorAll('.nav-menu .dropdown, #nav-inventory').forEach(element => {
            element.style.display = 'none';
          });
      }
    }

    // Logout Functionality
    logoutButton.addEventListener('click', () => {
      if (confirm('Are you sure you want to logout?')) {
        showLoading();
        auth.signOut()
          .then(() => {
            alert('Successfully logged out.');
          })
          .catch((error) => {
            alert('Logout failed: ' + error.message);
          })
          .finally(() => {
            hideLoading();
          });
      }
    });

    // Add Stock In - Office Functionality
    stockInOfficeButton.addEventListener('click', () => {
      const name = stockInOfficeNameInput.value.trim();
      const quantity = stockInOfficeQuantityInput.value.trim();
      const unit = stockInOfficeUnitInput.value.trim();
      const expiredDate = stockInOfficeExpiredDateInput.value; // Optional
      const location = stockInOfficeLocationSelect.value;

      // Permission Check
      if (!canPerformAction('stock-in', location)) {
        stockInOfficeError.textContent = 'You do not have permission to perform this action.';
        return;
      }

      // Basic Validation
      if (name === '' || quantity === '' || unit === '' || location === '') {
        stockInOfficeError.textContent = 'Please fill in all required fields.';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        stockInOfficeError.textContent = 'User not authenticated.';
        return;
      }

      showLoading();

      // Determine Target Path
      let targetPath = null;

      if (userRole === 'admin' || userRole === 'admino') {
        targetPath = 'inventory/office';
      } else if (userRole === 'admink') {
        targetPath = 'inventory/kepayan';
      } else {
        // Regular users likely do not have permission to perform stock in
        targetPath = null;
      }

      if (!targetPath) {
        stockInOfficeError.textContent = 'You do not have permission to perform this action.';
        hideLoading();
        return;
      }

      const inventoryRef = db.ref(targetPath);
      const newItemRef = inventoryRef.push();

      // Prepare Data Object
      const itemData = {
        type: 'stock-in',
        name,
        quantity: Number(quantity),
        unit,
        location,
        createdTime: new Date().toISOString(), // ISO 8601 format
        modifiedTime: new Date().toISOString(), // ISO 8601 format
        modifiedBy: user.displayName || 'Unknown'
      };

      // If expiry date is provided, add to data object
      if (expiredDate) {
        itemData.expiredDate = expiredDate;
      }

      newItemRef.set(itemData, (error) => {
        if (error) {
          stockInOfficeError.textContent = 'Failed to add stock in item: ' + error.message;
        } else {
          // Add transaction record
          const transactionData = {
            type: 'stock-in',
            productName: name,
            category: 'N/A', // Can set as needed
            quantity: Number(quantity),
            unit: unit,
            location: location,
            time: new Date().toISOString(), // ISO 8601 format
            user: user.displayName || 'Unknown',
            comment: 'None' // Default comment
          };
          db.ref('transactions').push(transactionData);

          // Clear form
          stockInOfficeError.textContent = '';
          stockInOfficeNameInput.value = '';
          stockInOfficeQuantityInput.value = '';
          stockInOfficeUnitInput.value = '';
          stockInOfficeExpiredDateInput.value = '';
          stockInOfficeLocationSelect.value = 'office';
        }
        hideLoading();
      });
    });

    // Add Stock In - Kepayan - Seafood Functionality
    stockInKepayanSeafoodButton.addEventListener('click', () => {
      const name = stockInKepayanSeafoodNameInput.value.trim();
      const category = stockInKepayanSeafoodCategorySelect.value;
      const quantity = stockInKepayanSeafoodQuantityInput.value.trim();
      const unit = stockInKepayanSeafoodUnitInput.value.trim();
      const expiredDate = stockInKepayanSeafoodExpiredDateInput.value;
      const location = stockInKepayanSeafoodLocationSelect.value; // 'office' or 'kepayan'

      // Permission Check
      if (!canPerformAction('stock-in', location)) {
        stockInKepayanSeafoodError.textContent = 'You do not have permission to perform this action.';
        return;
      }

      // Validate Fields
      if (name === '' || category === '' || quantity === '' || unit === '' || location === '') {
        stockInKepayanSeafoodError.textContent = 'Please fill in all required fields.';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        stockInKepayanSeafoodError.textContent = 'User not authenticated.';
        return;
      }

      showLoading();

      // Determine Target Path
      let targetPath;
      if (location === 'office') {
        targetPath = 'inventory/office';
      } else if (location === 'kepayan') {
        targetPath = 'inventory/kepayan';
      } else {
        // If there are more locations, handle accordingly
        stockInKepayanSeafoodError.textContent = 'Unknown location, unable to add to inventory.';
        hideLoading();
        return;
      }

      const inventoryRef = db.ref(targetPath);
      const newItemRef = inventoryRef.push();
      const itemData = {
        type: 'stock-in',
        name,
        category,
        quantity: Number(quantity),
        unit,
        location,
        createdTime: new Date().toISOString(), // ISO 8601 format
        modifiedTime: new Date().toISOString(), // ISO 8601 format
        modifiedBy: user.displayName || 'Unknown'
      };

      if (expiredDate) {
        itemData.expiredDate = expiredDate;
      }

      newItemRef.set(itemData, (error) => {
        if (error) {
          stockInKepayanSeafoodError.textContent = 'Failed to add stock in item: ' + error.message;
        } else {
          // Record transaction
          const transactionData = {
            type: 'stock-in',
            productName: name,
            category: category || 'N/A',
            quantity: Number(quantity),
            unit: unit,
            location: location,
            time: new Date().toISOString(), // ISO 8601 format
            user: user.displayName || 'Unknown',
            comment: 'None' // Default comment
          };
          db.ref('transactions').push(transactionData);

          // Clear form
          stockInKepayanSeafoodError.textContent = '';
          stockInKepayanSeafoodNameInput.value = '';
          stockInKepayanSeafoodCategorySelect.value = 'Seafood';
          stockInKepayanSeafoodQuantityInput.value = '';
          stockInKepayanSeafoodUnitInput.value = '';
          stockInKepayanSeafoodExpiredDateInput.value = '';
          stockInKepayanSeafoodLocationSelect.value = 'kepayan';
        }
        hideLoading();
      });
    });

    // Add Stock In - Kepayan - Packaged Food Functionality
    stockInKepayanPackagedButton.addEventListener('click', () => {
      const name = stockInKepayanPackagedNameInput.value.trim();
      const category = stockInKepayanPackagedCategorySelect.value;
      const quantity = stockInKepayanPackagedQuantityInput.value.trim();
      const unit = stockInKepayanPackagedUnitInput.value.trim();
      const expiredDate = stockInKepayanPackagedExpiredDateInput.value; // Optional
      const location = stockInKepayanPackagedLocationSelect.value;

      // Permission Check
      if (!canPerformAction('stock-in', location)) {
        stockInKepayanPackagedError.textContent = 'You do not have permission to perform this action.';
        return;
      }

      // Basic Validation
      if (name === '' || category === '' || quantity === '' || unit === '' || location === '') {
        stockInKepayanPackagedError.textContent = 'Please fill in all required fields.';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        stockInKepayanPackagedError.textContent = 'User not authenticated.';
        return;
      }

      showLoading();

      // Determine Target Path
      let targetPath = null;

      if (userRole === 'admin' || userRole === 'admino') {
        targetPath = 'inventory/office';
      } else if (userRole === 'admink') {
        targetPath = 'inventory/kepayan';
      } else {
        // Regular users likely do not have permission to perform stock in
        targetPath = null;
      }

      if (!targetPath) {
        stockInKepayanPackagedError.textContent = 'You do not have permission to perform this action.';
        hideLoading();
        return;
      }

      const inventoryRef = db.ref(targetPath);
      const newItemRef = inventoryRef.push();

      // Prepare Data Object
      const itemData = {
        type: 'stock-in',
        name,
        category,
        quantity: Number(quantity),
        unit,
        location,
        createdTime: new Date().toISOString(), // ISO 8601 format
        modifiedTime: new Date().toISOString(), // ISO 8601 format
        modifiedBy: user.displayName || 'Unknown'
      };

      // If expiry date is provided, add to data object
      if (expiredDate) {
        itemData.expiredDate = expiredDate;
      }

      newItemRef.set(itemData, (error) => {
        if (error) {
          stockInKepayanPackagedError.textContent = 'Failed to add stock in item: ' + error.message;
        } else {
          // Add transaction record
          const transactionData = {
            type: 'stock-in',
            productName: name,
            category: category || 'N/A',
            quantity: Number(quantity),
            unit: unit,
            location: location,
            time: new Date().toISOString(), // ISO 8601 format
            user: user.displayName || 'Unknown',
            comment: 'None' // Default comment
          };
          db.ref('transactions').push(transactionData);

          // Clear form
          stockInKepayanPackagedError.textContent = '';
          stockInKepayanPackagedNameInput.value = '';
          stockInKepayanPackagedCategorySelect.value = 'Packaged Food';
          stockInKepayanPackagedQuantityInput.value = '';
          stockInKepayanPackagedUnitInput.value = '';
          stockInKepayanPackagedExpiredDateInput.value = '';
          stockInKepayanPackagedLocationSelect.value = 'kepayan';
        }
        hideLoading();
      });
    });

    // Load Inventory List and Set Up Real-Time Listeners
    function loadInventoryForRole() {
      const inventoryPaths = getInventoryPaths();
      inventoryTableBody.innerHTML = '';
      inventoryCardsContainer.innerHTML = '';
      inventoryMessage.textContent = '';

      if (inventoryPaths.length === 0) {
        inventoryMessage.textContent = 'You do not have permission to view any inventory.';
        return;
      }

      let allItems = {};

      inventoryPaths.forEach(path => {
        const inventoryRef = db.ref(path);

        // Listen for child added
        inventoryRef.on('child_added', (snapshot) => {
          const item = { id: snapshot.key, ...snapshot.val() };
          allItems[item.id] = item;
          addItemToDOM(item);
          sortInventory();
        });

        // Listen for child changed
        inventoryRef.on('child_changed', (snapshot) => {
          const updatedItem = { id: snapshot.key, ...snapshot.val() };
          allItems[updatedItem.id] = updatedItem;
          updateItemInDOM(updatedItem);
          sortInventory();
        });

        // Listen for child removed
        inventoryRef.on('child_removed', (snapshot) => {
          const removedItemId = snapshot.key;
          delete allItems[removedItemId];
          removeItemFromDOM(removedItemId);
          sortInventory();
        });
      });

      // Display message if no data exists
      Promise.all(inventoryPaths.map(path => db.ref(path).once('value')))
        .then((snapshots) => {
          const hasData = snapshots.some(snapshot => snapshot.exists());
          if (!hasData) {
            inventoryMessage.textContent = 'No inventory data available.';
          }
        })
        .catch(error => {
          console.error('Failed to load inventory data:', error);
          inventoryMessage.textContent = 'Failed to load inventory data: ' + error.message;
        });
    }

    // Add Inventory Item to DOM
    function addItemToDOM(item) {
      const tr = createTableRow(item);
      inventoryTableBody.appendChild(tr);

      const card = createCard(item);
      card.setAttribute('data-item-id', item.id);
      inventoryCardsContainer.appendChild(card);
    }

    // Update Inventory Item in DOM
    function updateItemInDOM(item) {
      // Update table row
      const rows = inventoryTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const editButton = row.querySelector('.edit-button');
        if (editButton && editButton.getAttribute('data-item-id') === item.id) {
          row.innerHTML = `
            <td>${item.name}</td>
            <td class="hide-on-mobile">${item.category ? item.category : 'N/A'}</td>
            <td>${item.quantity}</td>
            <td class="hide-on-mobile">${item.unit}</td>
            <td class="hide-on-mobile">${item.expiredDate ? item.expiredDate : 'N/A'}</td>
            <td class="hide-on-mobile">${item.location}</td>
            <td class="hide-on-mobile">${formatDateTime(item.modifiedTime)}</td>
            <td class="hide-on-mobile">${item.modifiedBy}</td>
            <td>
              <button class="edit-button" data-item-id="${item.id}">
                <i class="fas fa-edit"></i> Edit
              </button>
            </td>
          `;
        }
      });

      // Update card
      const card = inventoryCardsContainer.querySelector(`.inventory-card[data-item-id="${item.id}"]`);
      if (card) {
        card.innerHTML = `
          <p><strong>Product Name:</strong> ${item.name}</p>
          <p><strong>Quantity:</strong> ${item.quantity}</p>
          <p><strong>Expiry Date:</strong> ${item.expiredDate ? item.expiredDate : 'N/A'}</p>
          <button class="edit-button" data-item-id="${item.id}">
            <i class="fas fa-edit"></i> Edit
          </button>
        `;
      }
    }

    // Remove Inventory Item from DOM
    function removeItemFromDOM(itemId) {
      // Remove table row
      const rows = inventoryTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const stockOutButton = row.querySelector('.stock-out-button');
        if (stockOutButton && stockOutButton.getAttribute('data-item-id') === itemId) {
          inventoryTableBody.removeChild(row);
        }
      });

      // Remove card
      const card = inventoryCardsContainer.querySelector(`.inventory-card[data-item-id="${itemId}"]`);
      if (card) {
        inventoryCardsContainer.removeChild(card);
      }
    }

    // Create Table Row for Inventory Item
    function createTableRow(item) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.name}</td>
        <td class="hide-on-mobile">${item.category ? item.category : 'N/A'}</td>
        <td>${item.quantity}</td>
        <td class="hide-on-mobile">${item.unit}</td>
        <td class="hide-on-mobile">${item.expiredDate ? item.expiredDate : 'N/A'}</td>
        <td class="hide-on-mobile">${item.location}</td>
        <td class="hide-on-mobile">${formatDateTime(item.modifiedTime)}</td>
        <td class="hide-on-mobile">${item.modifiedBy}</td>
        <td>
          <button class="edit-button" data-item-id="${item.id}">
            <i class="fas fa-edit"></i> Edit
          </button>
        </td>
      `;
      return tr;
    }

    // Create Card for Inventory Item (Mobile)
    function createCard(item) {
      const card = document.createElement('div');
      card.classList.add('inventory-card');
      card.innerHTML = `
        <p><strong>Product Name:</strong> ${item.name}</p>
        <p><strong>Quantity:</strong> ${item.quantity}</p>
        <p><strong>Expiry Date:</strong> ${item.expiredDate ? item.expiredDate : 'N/A'}</p>
        <button class="edit-button" data-item-id="${item.id}">
          <i class="fas fa-edit"></i> Edit
        </button>
      `;
      return card;
    }

    // Open Edit Modal
    function openEditModal(itemId, type, name, category, quantity, unit, expiredDate, location) {
      document.getElementById('edit-item-name').value = name;
      document.getElementById('edit-item-category').value = category || '';
      const quantityInput = document.getElementById('edit-item-quantity');
      quantityInput.value = quantity;
      quantityInput.setAttribute('data-original-quantity', quantity); // Store original quantity
      document.getElementById('edit-item-unit').value = unit;
      document.getElementById('edit-item-expired-date').value = expiredDate || '';
      document.getElementById('edit-item-location').value = location;
      
      currentEditItemId = itemId;
      document.getElementById('edit-modal').style.display = 'block';
    }

    // Close Edit Modal
    closeModalSpan.onclick = function() {
      editModal.style.display = 'none';
    }

    // Close Stock Out Modal
    closeStockOutModalSpan.onclick = function() {
      stockOutModal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == editModal) {
        editModal.style.display = 'none';
      }
      if (event.target == stockOutModal) { // Added
        stockOutModal.style.display = 'none';
      }
    }

    // Save Edited Inventory Item
    saveEditButton.addEventListener('click', () => {
      const name = document.getElementById('edit-item-name').value.trim();
      const category = document.getElementById('edit-item-category').value;
      const quantity = document.getElementById('edit-item-quantity').value.trim();
      const unit = document.getElementById('edit-item-unit').value.trim();
      const expiredDate = document.getElementById('edit-item-expired-date').value;
      const location = document.getElementById('edit-item-location').value;
      const user = auth.currentUser;

      // Basic validation
      if (!name || !quantity || !unit || !location) {
        document.getElementById('edit-item-error').textContent = 'Please fill in all required fields.';
        return;
      }

      if (!user) {
        document.getElementById('edit-item-error').textContent = 'User not authenticated.';
        return;
      }

      // Show loading
      showLoading();

      // Get the correct inventory path based on location and category
      let inventoryPath;
      if (location === 'office') {
        inventoryPath = 'inventory/office';
      } else if (location === 'kepayan') {
        if (category === 'Seafood') {
          inventoryPath = 'inventory/kepayan/seafood';
        } else if (category === 'Packaged Food') {
          inventoryPath = 'inventory/kepayan/packagedFood';
        }
      }

      if (!inventoryPath) {
        document.getElementById('edit-item-error').textContent = 'Invalid location or category combination.';
        hideLoading();
        return;
      }

      // Update item in database using the correct path
      const itemRef = db.ref(`${inventoryPath}/${currentEditItemId}`);
      itemRef.update({
        name,
        category,
        quantity: Number(quantity),
        unit,
        expiredDate: expiredDate || null,
        location,
        modifiedTime: new Date().toISOString(),
        modifiedBy: user.displayName || 'Unknown'
      })
      .then(() => {
        // Add transaction record for quantity change
        const originalQuantity = parseFloat(document.getElementById('edit-item-quantity').getAttribute('data-original-quantity') || '0');
        const newQuantity = parseFloat(quantity);
        
        if (originalQuantity !== newQuantity) {
          return db.ref('transactions').push({
            type: 'edit',
            productName: name,
            category: category || 'N/A',
            quantity: newQuantity - originalQuantity, // Positive for increase, negative for decrease
            unit: unit,
            location: location,
            time: new Date().toISOString(),
            user: user.displayName || 'Unknown',
            comment: 'Quantity edited'
          });
        }
      })
      .then(() => {
        // Hide modal and loading
        document.getElementById('edit-modal').style.display = 'none';
        document.getElementById('edit-item-error').textContent = '';
        hideLoading();
        
        // Refresh the inventory list
        loadInventoryList();
      })
      .catch((error) => {
        document.getElementById('edit-item-error').textContent = 'Failed to update item: ' + error.message;
        hideLoading();
      });
    });

    // Event Delegation: Click on "Stock Out" Button to Open Stock Out Modal
    document.addEventListener('click', (e) => {
      if (e.target && e.target.classList.contains('stock-out-button')) {
        currentStockOutItemId = e.target.getAttribute('data-item-id');
        stockOutQuantityInput.value = '';
        stockOutCommentInput.value = ''; // Reset to default
        stockOutError.textContent = '';
        stockOutModal.style.display = 'block';
      }

      // Click on Inventory Card to Open Edit Modal (Ensure it's not the Stock Out Button)
      if (e.target && e.target.closest('.inventory-card') && !e.target.classList.contains('stock-out-button')) {
        const card = e.target.closest('.inventory-card');
        const itemId = card.getAttribute('data-item-id');
        const user = auth.currentUser;
        if (user) {
          // Since inventory is shared, traverse all paths to find the item
          const inventoryPaths = getInventoryPaths();
          let found = false;

          inventoryPaths.forEach(path => {
            if (found) return;
            const itemRef = db.ref(`${path}/${itemId}`);
            itemRef.once('value', (snapshot) => {
              const item = snapshot.val();
              if (item && !found) {
                found = true;
                openEditModal(itemId, item.type, item.name, item.category, item.quantity, item.unit, item.expiredDate, item.location);
              }
            });
          });
        }
      }
    });

    // Save Stock Out Operation
    confirmStockOutButton.addEventListener('click', () => {
      const quantityToOut = stockOutQuantityInput.value.trim();
      const comment = stockOutCommentInput.value;
      const commentSelect = document.getElementById('stock-out-comment');

      // Basic Validation
      if (quantityToOut === '' || isNaN(quantityToOut) || Number(quantityToOut) <= 0) {
        stockOutError.textContent = 'Please enter a valid quantity greater than 0.';
        return;
      }

      // Validate Comment Selection
      if (comment === '') {
        stockOutError.textContent = 'Please select a comment.';
        commentSelect.classList.add('select-error'); // Add error style
        return;
      } else {
        commentSelect.classList.remove('select-error'); // Remove error style
      }

      const quantityNumber = Number(quantityToOut);

      const user = auth.currentUser;
      if (!user) {
        stockOutError.textContent = 'User not authenticated.';
        return;
      }

      showLoading();

      // Find the inventory item path
      const inventoryPaths = getInventoryPaths();
      let itemFound = false;

      inventoryPaths.forEach(path => {
        if (itemFound) return;

        const itemRef = db.ref(`${path}/${currentStockOutItemId}`);
        itemRef.once('value', (snapshot) => {
          const item = snapshot.val();
          if (item && item.quantity >= quantityNumber) {
            itemFound = true;
            const newQuantity = item.quantity - quantityNumber;

            // Update inventory quantity
            itemRef.update({
              quantity: newQuantity,
              modifiedTime: new Date().toISOString(), // ISO 8601 format
              modifiedBy: user.displayName || 'Unknown'
            }, (error) => {
              if (error) {
                stockOutError.textContent = 'Stock out failed: ' + error.message;
                hideLoading();
              } else {
                // Record transaction
                const transactionData = {
                  type: 'stock-out',
                  productName: item.name,
                  category: item.category || 'N/A',
                  quantity: quantityNumber,
                  unit: item.unit || 'N/A',
                  location: item.location,
                  time: new Date().toISOString(), // ISO 8601 format
                  user: user.displayName || 'Unknown',
                  comment: comment // Selected comment
                };
                db.ref('transactions').push(transactionData)
                  .then(() => {
                    stockOutError.textContent = '';
                    stockOutModal.style.display = 'none';
                  })
                  .catch((error) => {
                    stockOutError.textContent = 'Failed to record transaction: ' + error.message;
                  })
                  .finally(() => {
                    hideLoading();
                  });
              }
            });
          } else if (item && item.quantity < quantityNumber) {
            stockOutError.textContent = 'Stock out quantity exceeds available inventory.';
            hideLoading();
          }
        });
      });

      // If inventory item not found or invalid quantity
      setTimeout(() => {
        if (!itemFound) {
          stockOutError.textContent = 'Inventory item not found or invalid stock out quantity.';
          hideLoading();
        }
      }, 1000);
    });

    // Show Specific Section and Hide Others
    function showSection(section) {
      inventoryListSection.style.display = 'none';
      stockInOfficeSection.style.display = 'none';
      stockInKepayanSeafoodSection.style.display = 'none';
      stockInKepayanPackagedSection.style.display = 'none';
      transactionRecordsSection.style.display = 'none';
      stockOutSection.style.display = 'none';

      switch(section) {
        case 'inventory':
          inventoryListSection.style.display = 'block';
          break;
        case 'stock-in-office':
          stockInOfficeSection.style.display = 'block';
          break;
        case 'stock-in-kepayan-seafood':
          stockInKepayanSeafoodSection.style.display = 'block';
          break;
        case 'stock-in-kepayan-packaged':
          stockInKepayanPackagedSection.style.display = 'block';
          break;
        case 'transaction-records':
          transactionRecordsSection.style.display = 'block';
          loadTransactionRecords(); // Load transaction records
          break;
        case 'stock-out':
          stockOutSection.style.display = 'block';
          loadStockOutItems(); // Load stock out items
          break;
        default:
          inventoryListSection.style.display = 'block';
      }

      // Add this line to ensure proper responsive display
      handleResponsiveView();
    }

    // Add Event Listeners to Navigation Links
    navInventory.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('inventory');
    });

    navStockInOffice.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-in-office');
    });

    navStockInKepayanSeafood.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-in-kepayan-seafood');
    });

    navStockInKepayanPackaged.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-in-kepayan-packaged');
    });

    navTransactionRecords.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('transaction-records');
    });

    navStockOut.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-out');
      loadStockOutItems();
    });

    // Search Functionality for Inventory List
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      filterInventory(query);
    });

    // Filter Inventory Based on Search Query
    function filterInventory(query) {
      // Filter Table Rows
      const rows = inventoryTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const productName = row.querySelector('td').textContent.toLowerCase();
        if (productName.includes(query)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });

      // Filter Inventory Cards
      const cards = inventoryCardsContainer.querySelectorAll('.inventory-card');
      cards.forEach(card => {
        const productName = card.querySelector('p strong').nextSibling.textContent.toLowerCase();
        if (productName.includes(query)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }

    // Populate <select> Options Function (If Needed)
    function populateSelectOptions(selectElement, data, category, role, locationFilter) {
      // Clear existing options, keeping the first "Select Product" option
      selectElement.innerHTML = '<option value="">Select Product</option>';
      
      if (data) {
        let items = Object.keys(data)
          .filter(key => {
            if (category && data[key].category !== category) return false;
            if (locationFilter && data[key].location !== locationFilter) return false;
            if (data[key].type === 'stock-out') return false; // Only show stock-in types
            return data[key].quantity > 0;
          })
          .map(key => data[key].name);

        // Remove duplicate product names
        const uniqueItems = [...new Set(items)];

        uniqueItems.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          selectElement.appendChild(option);
        });
      }
    }

    // Load Transaction Records and Set Up Real-Time Listeners
    function loadTransactionRecords() {
      showLoading();
      db.ref('transactions').orderByChild('time').once('value')
        .then((snapshot) => {
          const data = snapshot.val();
          transactionRecordsTableBody.innerHTML = ''; // Clear table
          document.getElementById('transaction-records-cards').innerHTML = ''; // Clear cards

          if (data) {
            // Sort records by time descending
            const records = Object.values(data).sort((a, b) => new Date(b.time) - new Date(a.time));

            records.forEach(record => {
              // Add to table
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${record.productName}</td>
                <td class="hide-on-mobile">${record.category || 'N/A'}</td>
                <td>${record.quantity}</td>
                <td class="hide-on-mobile">${record.unit}</td>
                <td class="hide-on-mobile">${record.expiredDate || 'N/A'}</td>
                <td>${formatDateTime(record.time)}</td> <!-- Display Transaction Time -->
                <td>${record.user}</td>
                <td>${record.comment || 'None'}</td>
              `;
              transactionRecordsTableBody.appendChild(tr);

              // Add to card (Mobile)
              const card = document.createElement('div');
              card.classList.add('transaction-card'); // Changed class to differentiate
              card.innerHTML = `
                <p><strong>Product Name:</strong> ${record.productName}</p>
                <p><strong>Category:</strong> ${record.category || 'N/A'}</p>
                <p><strong>Quantity:</strong> ${record.quantity}</p>
                <p><strong>Unit:</strong> ${record.unit || 'N/A'}</p>
                <p><strong>Expiry Date:</strong> ${record.expiredDate || 'N/A'}</p>
                <p><strong>Transaction Time:</strong> ${formatDateTime(record.time)}</p> <!-- Added Transaction Time -->
                <p><strong>Modified By:</strong> ${record.user}</p>
                <p><strong>Comment:</strong> ${record.comment || 'None'}</p>
              `;
              document.getElementById('transaction-records-cards').appendChild(card);
            });
            transactionRecordsMessage.textContent = '';
          } else {
            transactionRecordsMessage.textContent = 'No transaction records available.';
          }
        })
        .catch((error) => {
          console.error('Failed to load transaction records:', error);
          transactionRecordsMessage.textContent = 'Failed to load transaction records: ' + error.message;
        })
        .finally(() => {
          hideLoading();
        });
    }

    // Sort Inventory List by Modified Time Descending
    function sortInventory() {
      // Get all rows from table
      const rows = Array.from(inventoryTableBody.querySelectorAll('tr'));
      // Sort rows based on the 'Last Modified Time' column (7th index, zero-based)
      rows.sort((a, b) => {
        const aTime = new Date(a.children[6].textContent.replace('(', '').replace(')', ''));
        const bTime = new Date(b.children[6].textContent.replace('(', '').replace(')', ''));
        return bTime - aTime;
      });
      // Append sorted rows back to the table body
      inventoryTableBody.innerHTML = '';
      rows.forEach(row => inventoryTableBody.appendChild(row));

      // Similarly sort cards based on 'modifiedTime' if needed
      // Assuming we have a data structure to sort cards, otherwise skip
    }

    // Show Loading Indicator
    function showLoading() {
      loadingIndicator.style.display = 'block';
    }

    // Hide Loading Indicator
    function hideLoading() {
      loadingIndicator.style.display = 'none';
    }

    // Check if User Can Perform Specific Action Based on Role and Location
    function canPerformAction(action, location) {
      switch(userRole) {
        case 'admin':
          return true;
        case 'adminv':
          return action === 'view'; // adminv can only view
        case 'admino':
          return (action === 'view' || action === 'stock-in' || action === 'stock-out') && location === 'office';
        case 'admink':
          return (action === 'view' || action === 'stock-in' || action === 'stock-out') && location === 'kepayan';
        case 'user':
          return action === 'view'; // user can only view inventory list
        default:
          return false;
      }
    }

    // Perform Action with Permission Check
    function performAction(action, location, callback) {
      if (canPerformAction(action, location)) {
        callback();
      } else {
        alert('You do not have permission to perform this action.');
      }
    }

    // Handle Responsive View for Tables and Cards
    function handleResponsiveView() {
      const tableResponsive = document.querySelector('.table-responsive');
      const cardsContainer = document.getElementById('inventory-cards');
      const transactionTable = document.getElementById('transaction-records-table');
      const transactionCards = document.getElementById('transaction-records-cards');

      if (window.innerWidth <= 600) {
        // Mobile view
        if (tableResponsive) tableResponsive.style.display = 'none';
        if (cardsContainer) cardsContainer.style.display = 'flex';
        if (transactionTable) transactionTable.parentElement.style.display = 'none';
        if (transactionCards) transactionCards.style.display = 'flex';
      } else {
        // Desktop view
        if (tableResponsive) tableResponsive.style.display = 'block';
        if (cardsContainer) cardsContainer.style.display = 'none';
        if (transactionTable) transactionTable.parentElement.style.display = 'block';
        if (transactionCards) transactionCards.style.display = 'none';
      }
    }

    // Initialize View Based on Current Window Size
    window.addEventListener('load', handleResponsiveView);

    // Adjust View on Window Resize
    window.addEventListener('resize', handleResponsiveView);

    // Create and Sort Inventory Items
    // Already handled in addItemToDOM and updateItemInDOM by calling sortInventory()

    // Load Inventory List on Role Assignment
    // Already handled in loadInventoryForRole()

    // Toggle Password Visibility
    const togglePassword = document.getElementById('toggle-password');
    togglePassword.addEventListener('click', () => {
      const passwordInput = document.getElementById('login-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      togglePassword.classList.toggle('fa-eye-slash');
    });

    // Forgot Password Functionality
    const forgotPasswordLink = document.getElementById('forgot-password');
    forgotPasswordLink.addEventListener('click', (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      if (email === '') {
        alert('Please enter your email address to reset your password.');
        return;
      }
      showLoading();
      auth.sendPasswordResetEmail(email)
        .then(() => {
          alert('Password reset email sent. Please check your inbox.');
        })
        .catch((error) => {
          console.error('Password Reset Error:', error);
          alert('Failed to send password reset email: ' + error.message);
        })
        .finally(() => {
          hideLoading();
        });
    });

    // Load items for stock out
    function loadStockOutItems() {
      const tbody = stockOutTable.querySelector('tbody');
      tbody.innerHTML = '';
      
      const inventoryPaths = getInventoryPaths();
      inventoryPaths.forEach(path => {
        const inventoryRef = db.ref(path);
        inventoryRef.once('value', (snapshot) => {
          snapshot.forEach((childSnapshot) => {
            const item = childSnapshot.val();
            if (item.quantity > 0) {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><input type="checkbox" class="item-checkbox" data-id="${childSnapshot.key}" data-path="${path}"></td>
                <td>${item.name}</td>
                <td>${item.category || 'N/A'}</td>
                <td>${item.quantity}</td>
                <td>${item.unit}</td>
                <td>${item.location}</td>
                <td><input type="number" class="stock-out-quantity" min="1" max="${item.quantity}" disabled></td>
              `;
              tbody.appendChild(tr);
            }
          });
        });
      });
    }

    // Handle select all checkbox
    selectAllItems.addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.item-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
        const quantityInput = checkbox.closest('tr').querySelector('.stock-out-quantity');
        quantityInput.disabled = !e.target.checked;
      });
      updateBatchStockOutButton();
    });

    // Handle individual checkboxes
    stockOutTable.addEventListener('change', (e) => {
      if (e.target.classList.contains('item-checkbox')) {
        const quantityInput = e.target.closest('tr').querySelector('.stock-out-quantity');
        quantityInput.disabled = !e.target.checked;
        updateBatchStockOutButton();
      }
    });

    // Update batch stock out button state
    function updateBatchStockOutButton() {
      const checkedItems = document.querySelectorAll('.item-checkbox:checked');
      batchStockOutButton.disabled = checkedItems.length === 0;
    }

    // Handle batch stock out
    batchStockOutButton.addEventListener('click', async () => {
      const comment = document.getElementById('stock-out-comment').value;
      if (!comment) {
        alert('Please select a comment for the stock out operation.');
        return;
      }

      const checkedItems = document.querySelectorAll('.item-checkbox:checked');
      const stockOutPromises = [];
      const user = auth.currentUser;

      checkedItems.forEach(checkbox => {
        const tr = checkbox.closest('tr');
        const quantityInput = tr.querySelector('.stock-out-quantity');
        const quantity = parseInt(quantityInput.value);
        const itemId = checkbox.getAttribute('data-id');
        const path = checkbox.getAttribute('data-path');

        if (quantity > 0) {
          const itemRef = db.ref(`${path}/${itemId}`);
          stockOutPromises.push(
            itemRef.once('value').then(snapshot => {
              const item = snapshot.val();
              if (item.quantity >= quantity) {
                return itemRef.update({
                  quantity: item.quantity - quantity,
                  modifiedTime: new Date().toISOString(),
                  modifiedBy: user.displayName || 'Unknown'
                }).then(() => {
                  // Add transaction record
                  return db.ref('transactions').push({
                    type: 'stock-out',
                    productName: item.name,
                    category: item.category || 'N/A',
                    quantity: quantity,
                    unit: item.unit,
                    location: item.location,
                    time: new Date().toISOString(),
                    user: user.displayName || 'Unknown',
                    comment: comment
                  });
                });
              } else {
                throw new Error(`Insufficient quantity for ${item.name}`);
              }
            })
          );
        }
      });

      try {
        showLoading();
        await Promise.all(stockOutPromises);
        alert('Batch stock out completed successfully');
        loadStockOutItems(); // Reload the table
      } catch (error) {
        alert('Error processing batch stock out: ' + error.message);
      } finally {
        hideLoading();
      }
    });

    // Search and filter functionality
    stockOutSearch.addEventListener('input', filterStockOutItems);
    stockOutLocationFilter.addEventListener('change', filterStockOutItems);

    function filterStockOutItems() {
      const searchTerm = stockOutSearch.value.toLowerCase();
      const locationFilter = stockOutLocationFilter.value;
      
      const rows = stockOutTable.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const productName = row.cells[1].textContent.toLowerCase();
        const location = row.cells[5].textContent;
        const matchesSearch = productName.includes(searchTerm);
        const matchesLocation = locationFilter === 'all' || location === locationFilter;
        row.style.display = matchesSearch && matchesLocation ? '' : 'none';
      });
    }

    // Handle edit button clicks
    document.addEventListener('click', (e) => {
      if (e.target.closest('.edit-button')) {
        const button = e.target.closest('.edit-button');
        const itemId = button.getAttribute('data-item-id');
        const user = auth.currentUser;
        
        if (user) {
          const inventoryPaths = getInventoryPaths();
          let found = false;

          inventoryPaths.forEach(path => {
            if (found) return;
            const itemRef = db.ref(`${path}/${itemId}`);
            itemRef.once('value', (snapshot) => {
              const item = snapshot.val();
              if (item && !found) {
                found = true;
                // Open edit modal with item data
                document.getElementById('edit-item-name').value = item.name;
                document.getElementById('edit-item-category').value = item.category || '';
                document.getElementById('edit-item-quantity').value = item.quantity;
                document.getElementById('edit-item-unit').value = item.unit;
                document.getElementById('edit-item-expired-date').value = item.expiredDate || '';
                document.getElementById('edit-item-location').value = item.location;
                
                // Store current item ID for save operation
                currentEditItemId = itemId;
                
                // Show modal
                document.getElementById('edit-modal').style.display = 'block';
              }
            });
          });
        }
      }
    });

    // Close modal when clicking outside or on close button
    window.onclick = function(event) {
      const modal = document.getElementById('edit-modal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    };

    document.querySelector('.close').onclick = function() {
      document.getElementById('edit-modal').style.display = 'none';
    };
  </script>
</body>
</html>
