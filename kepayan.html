<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Warehouse Management System</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pICvZonb6pj+/U6h8S86YtDj2OmyH9DlK6tm+VQf+U4km/DomZ+ZSSMwL8vqbsOYb7jz0VJo4zQ9ejO9L6LQDw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <style>
       h1 {
            text-align: center;
        }
    /* Basic Styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #71b7e6, white);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.5s ease;
    }
    
    /* Change body background when user is logged in */
    body.logged-in {
      background: #f4f4f4;
      justify-content: flex-start;
      align-items: flex-start;
      padding-top: 0;
    }
    
    header {
      background-color: #1976d2;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    nav {
      background-color: #ffffff;
      padding: 10px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .nav-menu {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center; /* Center navigation menu */
    }
    
    .nav-menu li {
      margin-right: 20px;
      position: relative;
    }
    
    .nav-menu li:last-child {
      margin-right: 0;
    }
    
    .nav-menu a {
      text-decoration: none;
      color: #1976d2;
      font-weight: bold;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background-color 0.3s, color 0.3s;
    }
    
    .nav-menu a:hover {
      background-color: #1976d2;
      color: white;
    }
    
    main {
      padding: 20px;
      width: 100%;
      max-width: 1200px;
    }
    
    section {
      background-color: #ffffff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input, select, button {
      width: 100%;
      padding: 10px 40px 10px 15px;
      margin-bottom: 15px;
      border: 1px solid #cccccc;
      border-radius: 25px;
      box-sizing: border-box;
      outline: none;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
      border-color: #1976d2;
      box-shadow: 0 0 5px rgba(25, 118, 210, 0.5);
    }
    
    button {
      background-color: #1976d2;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 25px;
      font-size: 1em;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
    }
    
    button:hover {
      background-color: #004ba0;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .error-message {
      color: red;
      font-size: 0.9em;
    }
    
    /* Loading Indicator Styles */
    #loading-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 1000;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      position: relative;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }
    
    .close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
    
    /* Table Styles */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    table, th, td {
      border: 1px solid #dddddd;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
    }
    
    th {
      background-color: #1976d2;
      color: white;
    }
    
    .hide-on-mobile {
      display: table-cell;
    }
    
    @media (max-width: 600px) {
      .hide-on-mobile {
        display: none;
      }
      
      .cards-container {
        display: flex;
        flex-direction: column;
      }
      
      .inventory-card {
        border: 1px solid #dddddd;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 6px;
        background-color: #fafafa;
      }
    }
    
    /* Dropdown Menu Styles */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #ffffff;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 6px;
    }
    
    .dropdown-content a {
      color: #1976d2;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background-color 0.3s;
    }
    
    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }
    
    .dropdown:hover .dropdown-content {
      display: block;
    }
    
    /* Responsive Table Container */
    .table-responsive {
      overflow-x: auto;
    }

    /* Authentication Form Styles */
    #auth-container {
      width: 100%;
      max-width: 400px;
      background: rgba(255, 255, 255, 0.85);
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }

    #login-form, #register-form {
      display: flex;
      flex-direction: column;
    }

    #login-form h3, #register-form h3 {
      text-align: center;
      margin-bottom: 20px;
      color: #1976d2;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #login-form h3 i, #register-form h3 i {
      margin-right: 8px;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .checkbox-container input {
      width: auto;
      margin-right: 10px;
    }

    /* Input Field Icons */
    .input-group {
      position: relative;
      margin-bottom: 15px;
    }

    .input-group i {
      position: absolute;
      top: 50%;
      left: 15px;
      transform: translateY(-50%);
      color: #1976d2;
      pointer-events: none;
    }

    .input-group input {
      padding-left: 40px;
    }

    /* Link Styles */
    #login-form p, #register-form p {
      text-align: center;
    }

    #login-form a, #register-form a {
      color: #1976d2;
      text-decoration: none;
      font-weight: bold;
    }

    #login-form a:hover, #register-form a:hover {
      text-decoration: underline;
    }

    /* Main App Container Adjustments */
    #app-container {
      width: 100%;
      max-width: 1200px;
      padding: 20px;
    }

    /* Warehouse Management System Title Adjustments */
    header h2 {
      margin: 0;
      font-size: 1.5em;
    }

    /* User Information and Logout Button Alignment */
    #user-info {
      display: flex;
      align-items: center;
    }

    #welcome-message {
      margin-right: 15px;
      font-weight: bold;
    }

    /* Optimize Form Elements */
    input, select, button {
      font-size: 1em;
    }
  </style>
</head>
<body>
  <!-- Loading Indicator -->
  <div id="loading-indicator">
    <i class="fas fa-spinner fa-spin fa-3x"></i>
  </div>

  <!-- User Authentication Container -->
  <div id="auth-container">
    <!-- Login Form -->
    <div id="login-form">
      <h1><i class="fas fa-sign-in-alt"></i> SmartProfits</h1>
      <h3><i class="fas fa-sign-in-alt"></i> Login</h3>
      
      <div class="input-group">
        <i class="fas fa-envelope"></i>
        <input type="email" id="login-email" placeholder="Enter Email" required>
      </div>
      
      <div class="input-group">
        <i class="fas fa-lock"></i>
        <input type="password" id="login-password" placeholder="Enter Password" required>
      </div>
      
      <!-- Remember Me Checkbox -->
      <div class="checkbox-container">
        <input type="checkbox" id="remember-me">
        <label for="remember-me">Remember Me</label>
      </div>
      
      <button id="login-button"><i class="fas fa-sign-in-alt"></i> Login</button>
      <p>Don't have an account? <a href="#" id="show-register">Register</a></p>
      <p id="login-error" class="error-message"></p>
    </div>
    
    <!-- Register Form -->
    <div id="register-form" style="display: none;">
      <h3><i class="fas fa-user-plus"></i> Register</h3>
      <label for="register-name">Name</label>
      <input type="text" id="register-name" placeholder="Name" required>
      
      <label for="register-email">Email</label>
      <input type="email" id="register-email" placeholder="Email" required>
      
      <label for="register-password">Password</label>
      <input type="password" id="register-password" placeholder="Password" required>
      
      <button id="register-button"><i class="fas fa-user-plus"></i> Register</button>
      <p>Already have an account? <a href="#" id="show-login">Login</a></p>
      <p id="register-error" class="error-message"></p>
    </div>
  </div>

  <!-- Main Application Container -->
  <div id="app-container" style="display: none;">
    <header>
      <h2>Warehouse Management System</h2>
      <div id="user-info">
        <span id="welcome-message"></span>
        <button id="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </header>
    
    <nav>
      <ul class="nav-menu">
        <li><a href="#" id="nav-inventory"><i class="fas fa-boxes"></i> Inventory List</a></li>
        <!-- Stock In Dropdown Menu -->
        <li class="dropdown">
          <a href="#"><i class="fas fa-download"></i> Stock In</a>
          <div class="dropdown-content">
            <a href="#" id="nav-stock-in-office">Office</a>
            <a href="#" id="nav-stock-in-kepayan-seafood">Kepayan - Seafood</a>
            <a href="#" id="nav-stock-in-kepayan-packaged">Kepayan - Packaged Food</a>
          </div>
        </li>
        <!-- Add Stock In/Out Record -->
        <li><a href="#" id="nav-transaction-records"><i class="fas fa-exchange-alt"></i> Transaction Records</a></li>
      </ul>
    </nav>
    
    <main>
      <!-- Inventory List Section -->
      <section id="inventory-list-section">
        <h3>Inventory List</h3>
        <!-- Responsive Table -->
        <div class="table-responsive">
          <table id="inventory-table">
            <thead>
              <tr>
                <th>Product Name</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th class="hide-on-mobile">Expiration Date</th>
                <th>Location</th>
                <th class="hide-on-mobile">Time</th>
                <th class="hide-on-mobile">Operator</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Inventory items will be dynamically populated -->
            </tbody>
          </table>
        </div>
        <!-- Mobile Card Layout -->
        <div id="inventory-cards" class="cards-container" style="display: none;">
          <!-- Inventory item cards will be dynamically populated -->
        </div>
        <p id="inventory-message"></p>
      </section>
      
      <!-- Stock In - Office Section -->
      <section id="stock-in-office-section" style="display: none;">
        <h3>Stock In - Office</h3>
        <label for="stock-in-office-name">Product Name</label>
        <input type="text" id="stock-in-office-name" placeholder="Product Name" required>
        
        <label for="stock-in-office-quantity">Quantity</label>
        <input type="number" id="stock-in-office-quantity" placeholder="Quantity" required>
        
        <label for="stock-in-office-unit">Unit</label>
        <input type="text" id="stock-in-office-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
        
        <label for="stock-in-office-expired-date">Expiration Date (Optional)</label>
        <input type="date" id="stock-in-office-expired-date" placeholder="Expiration Date (Optional)">
        
        <label for="stock-in-office-location">Location</label>
        <select id="stock-in-office-location" required>
          <option value="office">Office</option>
        </select>
        
        <button id="stock-in-office-button"><i class="fas fa-download"></i> Add Stock In - Office</button>
        <p id="stock-in-office-error" class="error-message"></p>
      </section>
      
      <!-- Stock In - Kepayan - Seafood Section -->
      <section id="stock-in-kepayan-seafood-section" style="display: none;">
        <h3>Stock In - Kepayan - Seafood</h3>
        <label for="stock-in-kepayan-seafood-name">Product Name</label>
        <input type="text" id="stock-in-kepayan-seafood-name" placeholder="Product Name" required>
        
        <label for="stock-in-kepayan-seafood-category">Category</label>
        <select id="stock-in-kepayan-seafood-category" required>
          <option value="">Select Category</option>
          <option value="Seafood">Seafood</option>
        </select>
        
        <label for="stock-in-kepayan-seafood-quantity">Quantity</label>
        <input type="number" id="stock-in-kepayan-seafood-quantity" placeholder="Quantity" required>
        
        <label for="stock-in-kepayan-seafood-unit">Unit</label>
        <input type="text" id="stock-in-kepayan-seafood-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
        
        <label for="stock-in-kepayan-seafood-expired-date">Expiration Date (Optional)</label>
        <input type="date" id="stock-in-kepayan-seafood-expired-date" placeholder="Expiration Date (Optional)">
        
        <label for="stock-in-kepayan-seafood-location">Location</label>
        <select id="stock-in-kepayan-seafood-location" required>
          <option value="kepayan">Kepayan</option>
        </select>
        
        <button id="stock-in-kepayan-seafood-button"><i class="fas fa-download"></i> Add Stock In - Kepayan - Seafood</button>
        <p id="stock-in-kepayan-seafood-error" class="error-message"></p>
      </section>
      
      <!-- Stock In - Kepayan - Packaged Food Section -->
      <section id="stock-in-kepayan-packaged-section" style="display: none;">
        <h3>Stock In - Kepayan - Packaged Food</h3>
        <label for="stock-in-kepayan-packaged-name">Product Name</label>
        <input type="text" id="stock-in-kepayan-packaged-name" placeholder="Product Name" required>
        
        <label for="stock-in-kepayan-packaged-category">Category</label>
        <select id="stock-in-kepayan-packaged-category" required>
          <option value="">Select Category</option>
          <option value="Packaged Food">Packaged Food</option>
        </select>
        
        <label for="stock-in-kepayan-packaged-quantity">Quantity</label>
        <input type="number" id="stock-in-kepayan-packaged-quantity" placeholder="Quantity" required>
        
        <label for="stock-in-kepayan-packaged-unit">Unit</label>
        <input type="text" id="stock-in-kepayan-packaged-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
        
        <label for="stock-in-kepayan-packaged-expired-date">Expiration Date (Optional)</label>
        <input type="date" id="stock-in-kepayan-packaged-expired-date" placeholder="Expiration Date (Optional)">
        
        <label for="stock-in-kepayan-packaged-location">Location</label>
        <select id="stock-in-kepayan-packaged-location" required>
          <option value="kepayan">Kepayan</option>
        </select>
        
        <button id="stock-in-kepayan-packaged-button"><i class="fas fa-download"></i> Add Stock In - Kepayan - Packaged Food</button>
        <p id="stock-in-kepayan-packaged-error" class="error-message"></p>
      </section>
      
      <!-- Transaction Records Section -->
      <section id="transaction-records-section" style="display: none;">
        <h3>Transaction Records</h3>
        <!-- Responsive Table -->
        <div class="table-responsive">
          <table id="transaction-records-table">
            <thead>
              <tr>
                <th>Product Name</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Location</th>
                <th>Time</th>
                <th>Operator</th>
                <th>Comment</th>
              </tr>
            </thead>
            <tbody>
              <!-- Transaction records will be dynamically populated -->
            </tbody>
          </table>
        </div>
        <p id="transaction-records-message"></p>
      </section>
    </main>
  </div>

  <!-- Edit Inventory Item Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Edit Inventory Item</h3>
      
      <label for="edit-item-type">Type</label>
      <select id="edit-item-type" required>
        <option value="stock-in">Stock In</option>
        <option value="stock-out">Stock Out</option>
      </select>
      
      <label for="edit-item-name">Product Name</label>
      <input type="text" id="edit-item-name" placeholder="Product Name" required>
      
      <label for="edit-item-category">Category</label>
      <select id="edit-item-category" required>
        <option value="">Select Category</option>
        <option value="Packaged Food">Packaged Food</option>
        <option value="Seafood">Seafood</option>
      </select>
      
      <label for="edit-item-quantity">Quantity</label>
      <input type="number" id="edit-item-quantity" placeholder="Quantity" required>
      
      <label for="edit-item-unit">Unit</label>
      <input type="text" id="edit-item-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
      
      <label for="edit-item-expired-date">Expiration Date (Optional)</label>
      <input type="date" id="edit-item-expired-date" placeholder="Expiration Date (Optional)">
      
      <label for="edit-item-location">Location</label>
      <select id="edit-item-location" required>
        <option value="">Select Location</option>
        <option value="office">Office</option>
        <option value="kepayan">Kepayan</option>
      </select>
      
      <button id="save-edit-button">Save Changes</button>
      <p id="edit-item-error" class="error-message"></p>
    </div>
  </div>

  <!-- Stock Out Modal -->
  <div id="stock-out-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Stock Out</h3>
      
      <label for="stock-out-quantity">Quantity to Stock Out</label>
      <input type="number" id="stock-out-quantity" placeholder="Quantity" required>
      
      <label for="stock-out-comment">Comment (Optional)</label>
      <input type="text" id="stock-out-comment" placeholder="Comment (Optional)">
      
      <button id="confirm-stock-out-button"><i class="fas fa-check"></i> Confirm Stock Out</button>
      <p id="stock-out-error" class="error-message"></p>
    </div>
  </div>

  <script>
    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyDAK5KVv9oln2qS5EfNzox1snM19wa83-o",
      authDomain: "smart-profits-stock.firebaseapp.com",
      databaseURL: "https://smart-profits-stock-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smart-profits-stock",
      storageBucket: "smart-profits-stock.firebasestorage.app",
      messagingSenderId: "1029424292465",
      appId: "1:1029424292465:web:6de46925db8818d462b1d0",
      measurementId: "G-R0K4Q7JTGE"
    };

    // 初始化 Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // 获取页面元素
    const authContainer = document.getElementById('auth-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const loginButton = document.getElementById('login-button');
    const registerButton = document.getElementById('register-button');
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');

    const appContainer = document.getElementById('app-container');
    const logoutButton = document.getElementById('logout-button');
    const navInventory = document.getElementById('nav-inventory');
    const navStockInOffice = document.getElementById('nav-stock-in-office');
    const navStockInKepayanSeafood = document.getElementById('nav-stock-in-kepayan-seafood');
    const navStockInKepayanPackaged = document.getElementById('nav-stock-in-kepayan-packaged');
    const navTransactionRecords = document.getElementById('nav-transaction-records'); // 新增

    const inventoryListSection = document.getElementById('inventory-list-section');
    const stockInOfficeSection = document.getElementById('stock-in-office-section');
    const stockInKepayanSeafoodSection = document.getElementById('stock-in-kepayan-seafood-section');
    const stockInKepayanPackagedSection = document.getElementById('stock-in-kepayan-packaged-section');
    const transactionRecordsSection = document.getElementById('transaction-records-section'); // 新增

    // 进货按钮
    const stockInOfficeButton = document.getElementById('stock-in-office-button');
    const stockInKepayanSeafoodButton = document.getElementById('stock-in-kepayan-seafood-button');
    const stockInKepayanPackagedButton = document.getElementById('stock-in-kepayan-packaged-button');

    // 进货输入字段
    const stockInOfficeNameInput = document.getElementById('stock-in-office-name');
    const stockInOfficeQuantityInput = document.getElementById('stock-in-office-quantity');
    const stockInOfficeUnitInput = document.getElementById('stock-in-office-unit');
    const stockInOfficeExpiredDateInput = document.getElementById('stock-in-office-expired-date');
    const stockInOfficeLocationSelect = document.getElementById('stock-in-office-location');
    const stockInOfficeError = document.getElementById('stock-in-office-error');

    const stockInKepayanSeafoodNameInput = document.getElementById('stock-in-kepayan-seafood-name');
    const stockInKepayanSeafoodCategorySelect = document.getElementById('stock-in-kepayan-seafood-category');
    const stockInKepayanSeafoodQuantityInput = document.getElementById('stock-in-kepayan-seafood-quantity');
    const stockInKepayanSeafoodUnitInput = document.getElementById('stock-in-kepayan-seafood-unit');
    const stockInKepayanSeafoodExpiredDateInput = document.getElementById('stock-in-kepayan-seafood-expired-date');
    const stockInKepayanSeafoodLocationSelect = document.getElementById('stock-in-kepayan-seafood-location');
    const stockInKepayanSeafoodError = document.getElementById('stock-in-kepayan-seafood-error');

    const stockInKepayanPackagedNameInput = document.getElementById('stock-in-kepayan-packaged-name');
    const stockInKepayanPackagedCategorySelect = document.getElementById('stock-in-kepayan-packaged-category');
    const stockInKepayanPackagedQuantityInput = document.getElementById('stock-in-kepayan-packaged-quantity');
    const stockInKepayanPackagedUnitInput = document.getElementById('stock-in-kepayan-packaged-unit');
    const stockInKepayanPackagedExpiredDateInput = document.getElementById('stock-in-kepayan-packaged-expired-date');
    const stockInKepayanPackagedLocationSelect = document.getElementById('stock-in-kepayan-packaged-location');
    const stockInKepayanPackagedError = document.getElementById('stock-in-kepayan-packaged-error');

    const inventoryTableBody = document.querySelector('#inventory-table tbody');
    const inventoryMessage = document.getElementById('inventory-message');
    const inventoryCardsContainer = document.getElementById('inventory-cards');

    const transactionRecordsTableBody = document.querySelector('#transaction-records-table tbody'); // 新增
    const transactionRecordsMessage = document.getElementById('transaction-records-message'); // 新增

    const editModal = document.getElementById('edit-modal');
    const closeModalSpan = editModal.querySelector('.close');
    const editItemTypeSelect = document.getElementById('edit-item-type'); // 新增
    const editItemNameInput = document.getElementById('edit-item-name');
    const editItemCategorySelect = document.getElementById('edit-item-category');
    const editItemQuantityInput = document.getElementById('edit-item-quantity');
    const editItemUnitInput = document.getElementById('edit-item-unit');
    const editItemExpiredDateInput = document.getElementById('edit-item-expired-date');
    const editItemLocationSelect = document.getElementById('edit-item-location');
    const saveEditButton = document.getElementById('save-edit-button');
    const editItemError = document.getElementById('edit-item-error');

    const stockOutModal = document.getElementById('stock-out-modal'); // 新增
    const closeStockOutModalSpan = stockOutModal.querySelector('.close'); // 新增
    const confirmStockOutButton = document.getElementById('confirm-stock-out-button'); // 新增
    const stockOutQuantityInput = document.getElementById('stock-out-quantity'); // 新增
    const stockOutCommentInput = document.getElementById('stock-out-comment'); // 新增
    const stockOutError = document.getElementById('stock-out-error'); // 新增

    const loadingIndicator = document.getElementById('loading-indicator');

    // 获取用户信息显示元素
    const welcomeMessage = document.getElementById('welcome-message');

    let currentEditItemId = null; // 当前编辑的库存项ID
    let currentStockOutItemId = null; // 当前出货的库存项ID // 新增
    let userRole = null; // 当前用户角色

    /**
     * Formats an ISO 8601 date string to "dd-mm-yyyy (hh.mmam/pm)"
     * @param {string} isoString - The ISO 8601 date string.
     * @returns {string} - The formatted date string.
     */
    function formatDateTime(isoString) {
        const date = new Date(isoString);
        if (isNaN(date)) return 'Invalid Date';

        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
        const year = date.getFullYear();

        let hours = date.getHours();
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        const formattedTime = `${String(hours).padStart(2, '0')}.${minutes}${ampm}`;

        return `${day}-${month}-${year} (${formattedTime})`;
    }

    // 获取库存路径，根据用户角色动态设置
    function getInventoryPaths() {
      let paths = [];
      if (userRole === 'admin' || userRole === 'adminv') {
        paths = ['inventory/office', 'inventory/kepayan'];
      } else if (userRole === 'admino') {
        paths = ['inventory/office'];
      } else if (userRole === 'admink') {
        paths = ['inventory/kepayan'];
      } else {
        // 普通用户可能只能查看
        paths = ['inventory'];
      }
      return paths;
    }

    // 显示/隐藏注册表单
    showRegisterLink.addEventListener('click', (e) => {
      e.preventDefault();
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
    });

    showLoginLink.addEventListener('click', (e) => {
      e.preventDefault();
      registerForm.style.display = 'none';
      loginForm.style.display = 'block';
    });

    // 注册功能
    registerButton.addEventListener('click', (e) => {
      e.preventDefault();
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value.trim();

      if (name === '' || email === '' || password === '') {
        registerError.textContent = '请填写所有字段';
        return;
      }

      showLoading();

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // 注册成功，设置显示名称
          return userCredential.user.updateProfile({
            displayName: name
          });
        })
        .then(() => {
          // 将用户信息保存到数据库，并设置默认角色为"user"
          const user = auth.currentUser;
          if (user) {
            db.ref('users/' + user.uid).set({
              name: user.displayName,
              email: user.email,
              role: 'user' // 默认角色为"user"
            });
          }
          registerError.textContent = '';
          registerForm.reset();
        })
        .catch((error) => {
          console.error('注册错误:', error);
          registerError.textContent = error.message;
        })
        .finally(() => {
          hideLoading();
        });
    });

    // 登录功能（包含"记住我"）
    loginButton.addEventListener('click', (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const rememberMe = document.getElementById('remember-me').checked;

      if (email === '' || password === '') {
        loginError.textContent = '请填写所有字段';
        return;
      }

      showLoading();

      // 根据"记住我"设置持久性
      const persistence = rememberMe
        ? firebase.auth.Auth.Persistence.LOCAL
        : firebase.auth.Auth.Persistence.SESSION;

      auth.setPersistence(persistence)
        .then(() => {
          return auth.signInWithEmailAndPassword(email, password);
        })
        .then((userCredential) => {
          // 登录成功
          loginError.textContent = '';
          loginForm.reset();
        })
        .catch((error) => {
          console.error('登录错误:', error);
          loginError.textContent = error.message;
        })
        .finally(() => {
          hideLoading();
        });
    });

    // 监听认证状态变化
    auth.onAuthStateChanged((user) => {
      if (user) {
        // 用户已登录，获取用户角色
        authContainer.style.display = 'none';
        appContainer.style.display = 'block';
        document.body.classList.add('logged-in'); // 添加类以改变背景
        getUserRole(user.uid);

        // 显示欢迎消息
        const displayName = user.displayName || '用户';
        welcomeMessage.textContent = `欢迎, ${displayName} (${userRole ? userRole : '加载中...'})`;
      } else {
        // 用户未登录，显示登录/注册界面
        authContainer.style.display = 'block';
        appContainer.style.display = 'none';
        document.body.classList.remove('logged-in'); // 移除类恢复背景
        inventoryTableBody.innerHTML = '';
        inventoryCardsContainer.innerHTML = '';
        inventoryMessage.textContent = '';
        transactionRecordsTableBody.innerHTML = ''; // 清空交易记录表格
        transactionRecordsMessage.textContent = '';
        welcomeMessage.textContent = '';
      }
    });

    // 获取用户角色
    function getUserRole(uid) {
      db.ref('users/' + uid + '/role').once('value')
        .then((snapshot) => {
          userRole = snapshot.val();
          adjustUIBasedOnRole();
          loadInventoryForRole(); // 加载库存
          // populateStockOutOptions(); // 不需要
        })
        .then(() => {
          // 更新欢迎消息
          const user = auth.currentUser;
          const displayName = user.displayName || '用户';
          welcomeMessage.textContent = `欢迎, ${displayName} (${userRole})`;
        })
        .catch((error) => {
          console.error('获取用户角色失败:', error);
        });
    }

    // 根据角色调整UI
    function adjustUIBasedOnRole() {
      // 重置所有导航项的显示
      document.querySelectorAll('.nav-menu .dropdown, #nav-inventory').forEach(element => {
        element.style.display = 'block';
      });

      // 根据角色隐藏不允许的功能
      switch(userRole) {
        case 'admin':
          // admin: 访问所有功能，不需隐藏任何导航项
          break;
        case 'adminv':
          // adminv: 只能查看库存，隐藏进货功能
          document.querySelectorAll('.nav-menu .dropdown').forEach(dropdown => {
            dropdown.style.display = 'none';
          });
          break;
        case 'admino':
          // admino: 只能管理 office
          document.getElementById('nav-stock-in-kepayan-seafood').style.display = 'none';
          document.getElementById('nav-stock-in-kepayan-packaged').style.display = 'none';
          break;
        case 'admink':
          // admink: 只能管理 kepayan
          document.getElementById('nav-stock-in-office').style.display = 'none';
          break;
        case 'user':
          // user: 普通用户，隐藏所有功能，包括库存列表
          document.querySelectorAll('.nav-menu .dropdown, #nav-inventory').forEach(element => {
            element.style.display = 'none';
          });
          break;
        default:
          // 未定义角色，隐藏所有功能
          document.querySelectorAll('.nav-menu .dropdown, #nav-inventory').forEach(element => {
            element.style.display = 'none';
          });
      }
    }

    // 登出功能
    logoutButton.addEventListener('click', () => {
      if (confirm('确定要退出登录吗？')) {
        showLoading();
        auth.signOut()
          .then(() => {
            alert('成功退出登录');
          })
          .catch((error) => {
            alert('退出登录失败: ' + error.message);
          })
          .finally(() => {
            hideLoading();
          });
      }
    });

    // 添加进货功能 - Office
    stockInOfficeButton.addEventListener('click', () => {
      const name = stockInOfficeNameInput.value.trim();
      const quantity = stockInOfficeQuantityInput.value.trim();
      const unit = stockInOfficeUnitInput.value.trim();
      const expiredDate = stockInOfficeExpiredDateInput.value; // 可选
      const location = stockInOfficeLocationSelect.value;

      // 权限检查
      if (!canPerformAction('stock-in', location)) {
        stockInOfficeError.textContent = '您没有权限进行此操作';
        return;
      }

      // 基本验证
      if (name === '' || quantity === '' || unit === '' || location === '') {
        stockInOfficeError.textContent = '请填写所有必填字段';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        stockInOfficeError.textContent = '用户未认证';
        return;
      }

      showLoading();

      // 确定目标路径
      let targetPath = null;

      if (userRole === 'admin' || userRole === 'admino') {
        targetPath = 'inventory/office';
      } else if (userRole === 'admink') {
        targetPath = 'inventory/kepayan';
      } else {
        // 普通用户可能没有权限进行进货操作
        targetPath = null;
      }

      if (!targetPath) {
        stockInOfficeError.textContent = '您没有权限进行此操作';
        hideLoading();
        return;
      }

      const inventoryRef = db.ref(targetPath);
      const newItemRef = inventoryRef.push();

      // 准备数据对象
      const itemData = {
        type: 'stock-in',
        name,
        quantity: Number(quantity),
        unit,
        location,
        createdTime: new Date().toISOString(), // 修改为 ISO 8601 格式
        modifiedTime: new Date().toISOString(), // 修改为 ISO 8601 格式
        modifiedBy: user.displayName || '未知'
      };

      // 如果提供了过期日期，则添加到数据对象
      if (expiredDate) {
        itemData.expiredDate = expiredDate;
      }

      newItemRef.set(itemData, (error) => {
        if (error) {
          stockInOfficeError.textContent = '添加进货项失败: ' + error.message;
        } else {
          // 添加进货记录
          const transactionData = {
            type: 'stock-in',
            productName: name,
            category: 'N/A', // 可以根据需要设置
            quantity: Number(quantity),
            unit: unit,
            location: location,
            time: new Date().toISOString(), // 修改为 ISO 8601 格式
            user: user.displayName || '未知',
            comment: '无' // 默认无注释
          };
          db.ref('transactions').push(transactionData);

          // 清空表单
          stockInOfficeError.textContent = '';
          stockInOfficeNameInput.value = '';
          stockInOfficeQuantityInput.value = '';
          stockInOfficeUnitInput.value = '';
          stockInOfficeExpiredDateInput.value = '';
          stockInOfficeLocationSelect.value = 'office';
        }
        hideLoading();
      });
    });

    // 添加进货功能 - Kepayan - Seafood
    stockInKepayanSeafoodButton.addEventListener('click', () => {
      const name = stockInKepayanSeafoodNameInput.value.trim();
      const category = stockInKepayanSeafoodCategorySelect.value;
      const quantity = stockInKepayanSeafoodQuantityInput.value.trim();
      const unit = stockInKepayanSeafoodUnitInput.value.trim();
      const expiredDate = stockInKepayanSeafoodExpiredDateInput.value;
      const location = stockInKepayanSeafoodLocationSelect.value; // 'office' or 'kepayan' 等

      // ---- 1. 检查权限 ----
      if (!canPerformAction('stock-in', location)) {
        stockInKepayanSeafoodError.textContent = '您没有权限进行此操作';
        return;
      }

      // ---- 2. 根据 location 确定 targetPath ----
      let targetPath;
      if (location === 'office') {
        targetPath = 'inventory/office';
      } else if (location === 'kepayan') {
        targetPath = 'inventory/kepayan';
      } else {
        // 如果还会有更多其他地点，可以再做判断
        stockInKepayanSeafoodError.textContent = '未知地点，无法写入库存';
        return;
      }

      // ---- 3. 校验字段、写库等后续逻辑不变 ----
      if (name === '' || category === '' || quantity === '' || unit === '' || location === '') {
        stockInKepayanSeafoodError.textContent = '请填写所有必填字段';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        stockInKepayanSeafoodError.textContent = '用户未认证';
        return;
      }

      showLoading();

      const inventoryRef = db.ref(targetPath);
      const newItemRef = inventoryRef.push();
      const itemData = {
        type: 'stock-in',
        name,
        category,
        quantity: Number(quantity),
        unit,
        location,
        createdTime: new Date().toISOString(), // 修改为 ISO 8601 格式
        modifiedTime: new Date().toISOString(), // 修改为 ISO 8601 格式
        modifiedBy: user.displayName || '未知'
      };

      if (expiredDate) {
        itemData.expiredDate = expiredDate;
      }

      newItemRef.set(itemData, (error) => {
        if (error) {
          stockInKepayanSeafoodError.textContent = '添加进货项失败: ' + error.message;
        } else {
          // 记录 transactions ...
          const transactionData = {
            type: 'stock-in',
            productName: name,
            category: category || 'N/A',
            quantity: Number(quantity),
            unit: unit,
            location: location,
            time: new Date().toISOString(), // 修改为 ISO 8601 格式
            user: user.displayName || '未知',
            comment: '无' // 默认无注释
          };
          db.ref('transactions').push(transactionData);

          // 清空表单
          stockInKepayanSeafoodError.textContent = '';
          stockInKepayanSeafoodNameInput.value = '';
          stockInKepayanSeafoodCategorySelect.value = 'Seafood';
          stockInKepayanSeafoodQuantityInput.value = '';
          stockInKepayanSeafoodUnitInput.value = '';
          stockInKepayanSeafoodExpiredDateInput.value = '';
          stockInKepayanSeafoodLocationSelect.value = 'kepayan';
        }
        hideLoading();
      });
    });

    // 添加进货功能 - Kepayan - Packaged Food
    stockInKepayanPackagedButton.addEventListener('click', () => {
      const name = stockInKepayanPackagedNameInput.value.trim();
      const category = stockInKepayanPackagedCategorySelect.value;
      const quantity = stockInKepayanPackagedQuantityInput.value.trim();
      const unit = stockInKepayanPackagedUnitInput.value.trim();
      const expiredDate = stockInKepayanPackagedExpiredDateInput.value; // 可选
      const location = stockInKepayanPackagedLocationSelect.value;

      // 权限检查
      if (!canPerformAction('stock-in', location)) {
        stockInKepayanPackagedError.textContent = '您没有权限进行此操作';
        return;
      }

      // 基本验证
      if (name === '' || category === '' || quantity === '' || unit === '' || location === '') {
        stockInKepayanPackagedError.textContent = '请填写所有必填字段';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        stockInKepayanPackagedError.textContent = '用户未认证';
        return;
      }

      showLoading();

      // 确定目标路径
      let targetPath = null;

      if (userRole === 'admin' || userRole === 'admino') {
        targetPath = 'inventory/office';
      } else if (userRole === 'admink') {
        targetPath = 'inventory/kepayan';
      } else {
        // 普通用户可能没有权限进行进货操作
        targetPath = null;
      }

      if (!targetPath) {
        stockInKepayanPackagedError.textContent = '您没有权限进行此操作';
        hideLoading();
        return;
      }

      const inventoryRef = db.ref(targetPath);
      const newItemRef = inventoryRef.push();

      // 准备数据对象
      const itemData = {
        type: 'stock-in',
        name,
        category,
        quantity: Number(quantity),
        unit,
        location,
        createdTime: new Date().toISOString(), // 修改为 ISO 8601 格式
        modifiedTime: new Date().toISOString(), // 修改为 ISO 8601 格式
        modifiedBy: user.displayName || '未知'
      };

      // 如果提供了过期日期，则添加到数据对象
      if (expiredDate) {
        itemData.expiredDate = expiredDate;
      }

      newItemRef.set(itemData, (error) => {
        if (error) {
          stockInKepayanPackagedError.textContent = '添加进货项失败: ' + error.message;
        } else {
          // 添加进货记录
          const transactionData = {
            type: 'stock-in',
            productName: name,
            category: category || 'N/A',
            quantity: Number(quantity),
            unit: unit,
            location: location,
            time: new Date().toISOString(), // 修改为 ISO 8601 格式
            user: user.displayName || '未知',
            comment: '无' // 默认无注释
          };
          db.ref('transactions').push(transactionData);

          // 清空表单
          stockInKepayanPackagedError.textContent = '';
          stockInKepayanPackagedNameInput.value = '';
          stockInKepayanPackagedCategorySelect.value = 'Packaged Food';
          stockInKepayanPackagedQuantityInput.value = '';
          stockInKepayanPackagedUnitInput.value = '';
          stockInKepayanPackagedExpiredDateInput.value = '';
          stockInKepayanPackagedLocationSelect.value = 'kepayan';
        }
        hideLoading();
      });
    });

    // 加载库存列表并设置实时监听
    function loadInventoryForRole() {
      const inventoryPaths = getInventoryPaths();
      inventoryTableBody.innerHTML = '';
      inventoryCardsContainer.innerHTML = '';
      inventoryMessage.textContent = '';

      if (inventoryPaths.length === 0) {
        inventoryMessage.textContent = '您没有权限查看任何库存';
        return;
      }

      let allItems = {};

      inventoryPaths.forEach(path => {
        const inventoryRef = db.ref(path);

        // 监听子项被添加
        inventoryRef.on('child_added', (snapshot) => {
          const item = { id: snapshot.key, ...snapshot.val() };
          allItems[item.id] = item;
          addItemToDOM(item);
        });

        // 监听子项被修改
        inventoryRef.on('child_changed', (snapshot) => {
          const updatedItem = { id: snapshot.key, ...snapshot.val() };
          allItems[updatedItem.id] = updatedItem;
          updateItemInDOM(updatedItem);
        });

        // 监听子项被移除
        inventoryRef.on('child_removed', (snapshot) => {
          const removedItemId = snapshot.key;
          delete allItems[removedItemId];
          removeItemFromDOM(removedItemId);
        });
      });

      // 当所有路径都没有数据时显示消息
      Promise.all(inventoryPaths.map(path => db.ref(path).once('value')))
        .then((snapshots) => {
          const hasData = snapshots.some(snapshot => snapshot.exists());
          if (!hasData) {
            inventoryMessage.textContent = '暂无库存数据';
          }
        })
        .catch(error => {
          console.error('加载库存数据失败:', error);
          inventoryMessage.textContent = '加载库存数据失败: ' + error.message;
        });
    }

    // 添加库存项到 DOM
    function addItemToDOM(item) {
      const tr = createTableRow(item);
      inventoryTableBody.appendChild(tr);

      const card = createCard(item);
      card.setAttribute('data-item-id', item.id);
      inventoryCardsContainer.appendChild(card);
    }

    // 更新库存项在 DOM 中的显示
    function updateItemInDOM(item) {
      // 更新表格行
      const rows = inventoryTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const stockOutButton = row.querySelector('.stock-out-button');
        if (stockOutButton && stockOutButton.getAttribute('data-item-id') === item.id) {
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.category ? item.category : 'N/A'}</td>
            <td>${item.quantity}</td>
            <td>${item.unit}</td>
            <td class="hide-on-mobile">${item.expiredDate ? item.expiredDate : 'N/A'}</td>
            <td>${item.location}</td>
            <td class="hide-on-mobile">${formatDateTime(item.createdTime)}</td>
            <td class="hide-on-mobile">${item.modifiedBy}</td>
            <td><button class="stock-out-button" data-item-id="${item.id}">出货</button></td>
          `;
        }
      });

      // 更新卡片
      const card = inventoryCardsContainer.querySelector(`.inventory-card[data-item-id="${item.id}"]`);
      if (card) {
        card.innerHTML = `
          <p><strong>类别:</strong> ${item.category ? item.category : 'N/A'}</p>
          <p><strong>数量:</strong> ${item.quantity}</p>
          <p><strong>单位:</strong> ${item.unit}</p>
          <p><strong>过期日期:</strong> ${item.expiredDate ? item.expiredDate : 'N/A'}</p>
          <p><strong>位置:</strong> ${item.location}</p>
          <p><strong>时间:</strong> ${formatDateTime(item.createdTime)}</p>
          <p><strong>操作人:</strong> ${item.modifiedBy}</p>
          <button class="stock-out-button" data-item-id="${item.id}">出货</button>
        `;
      }
    }

    // 从 DOM 中移除库存项
    function removeItemFromDOM(itemId) {
      // 移除表格行
      const rows = inventoryTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const stockOutButton = row.querySelector('.stock-out-button');
        if (stockOutButton && stockOutButton.getAttribute('data-item-id') === itemId) {
          inventoryTableBody.removeChild(row);
        }
      });

      // 移除卡片
      const card = inventoryCardsContainer.querySelector(`.inventory-card[data-item-id="${itemId}"]`);
      if (card) {
        inventoryCardsContainer.removeChild(card);
      }
    }

    // 创建表格行
    function createTableRow(item) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.name}</td>
        <td>${item.category ? item.category : 'N/A'}</td>
        <td>${item.quantity}</td>
        <td>${item.unit}</td>
        <td class="hide-on-mobile">${item.expiredDate ? item.expiredDate : 'N/A'}</td>
        <td>${item.location}</td>
        <td class="hide-on-mobile">${formatDateTime(item.createdTime)}</td>
        <td class="hide-on-mobile">${item.modifiedBy}</td>
        <td><button class="stock-out-button" data-item-id="${item.id}"><i class="fas fa-box-open"></i> 出货</button></td>
      `;
      return tr;
    }

    // 创建卡片
    function createCard(item) {
      const card = document.createElement('div');
      card.classList.add('inventory-card');
      card.innerHTML = `
        <p><strong>类别:</strong> ${item.category ? item.category : 'N/A'}</p>
        <p><strong>数量:</strong> ${item.quantity}</p>
        <p><strong>单位:</strong> ${item.unit}</p>
        <p><strong>过期日期:</strong> ${item.expiredDate ? item.expiredDate : 'N/A'}</p>
        <p><strong>位置:</strong> ${item.location}</p>
        <p><strong>时间:</strong> ${formatDateTime(item.createdTime)}</p>
        <p><strong>操作人:</strong> ${item.modifiedBy}</p>
        <button class="stock-out-button" data-item-id="${item.id}"><i class="fas fa-box-open"></i> 出货</button>
      `;
      return card;
    }

    // 打开编辑模态框
    function openEditModal(itemId, type, name, category, quantity, unit, expiredDate, location) {
      currentEditItemId = itemId;
      editItemTypeSelect.value = type;
      editItemNameInput.value = name;
      editItemCategorySelect.value = category || '';
      editItemQuantityInput.value = quantity;
      editItemUnitInput.value = unit;
      editItemExpiredDateInput.value = expiredDate || '';
      editItemLocationSelect.value = location;
      editItemError.textContent = '';
      editModal.style.display = 'block';
    }

    // 关闭编辑模态框
    closeModalSpan.onclick = function() {
      editModal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == editModal) {
        editModal.style.display = 'none';
      }
      if (event.target == stockOutModal) { // 新增
        stockOutModal.style.display = 'none';
      }
    }

    // 保存编辑的库存项
    saveEditButton.addEventListener('click', () => {
      const type = editItemTypeSelect.value;
      const name = editItemNameInput.value.trim();
      const category = editItemCategorySelect.value;
      const quantity = editItemQuantityInput.value.trim();
      const unit = editItemUnitInput.value.trim();
      const expiredDate = editItemExpiredDateInput.value; // 可选
      const location = editItemLocationSelect.value;

      // 权限检查
      if (!canPerformAction('edit', location)) {
        editItemError.textContent = '您没有权限进行此操作';
        return;
      }

      // 基本验证
      if (type === '' || name === '' || quantity === '' || unit === '' || location === '') {
        editItemError.textContent = '请填写所有必填字段';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        editItemError.textContent = '用户未认证';
        return;
      }

      showLoading();

      // 确定目标路径
      let targetPath = null;

      if (userRole === 'admin' || userRole === 'admino') {
        targetPath = 'inventory';
      } else if (userRole === 'admink') {
        targetPath = 'inventory/kepayan';
      } else {
        // 普通用户可能没有权限进行编辑操作
        targetPath = null;
      }

      if (!targetPath) {
        editItemError.textContent = '您没有权限进行此操作';
        hideLoading();
        return;
      }

      const itemRef = db.ref(`${targetPath}/${currentEditItemId}`);
      
      // 准备更新的数据对象
      const updatedData = {
        type,
        name,
        quantity: Number(quantity),
        unit,
        location,
        modifiedTime: new Date().toISOString(), // 修改为 ISO 8601 格式
        modifiedBy: user.displayName || '未知'
      };

      // 如果类别存在（针对 Kepayan）
      if (category) {
        updatedData.category = category;
      } else {
        updatedData.category = 'N/A'; // 或者其他默认值
      }

      // 如果提供了过期日期，则添加到数据对象
      if (expiredDate) {
        updatedData.expiredDate = expiredDate;
      } else {
        updatedData.expiredDate = 'N/A'; // 或者其他默认值
      }

      itemRef.update(updatedData, (error) => {
        if (error) {
          editItemError.textContent = '更新库存项失败: ' + error.message;
        } else {
          editItemError.textContent = '';
          editModal.style.display = 'none';
        }
        hideLoading();
      });
    });

    // 事件委托：点击"出货"按钮打开出货模态框
    document.addEventListener('click', (e) => {
      if (e.target && e.target.classList.contains('stock-out-button')) {
        currentStockOutItemId = e.target.getAttribute('data-item-id');
        stockOutQuantityInput.value = '';
        stockOutCommentInput.value = '';
        stockOutError.textContent = '';
        stockOutModal.style.display = 'block';
      }

      // 点击库存项卡片进行编辑（确保点击的是卡片内容，而非按钮）
      if (e.target && e.target.closest('.inventory-card') && !e.target.classList.contains('stock-out-button')) {
        const card = e.target.closest('.inventory-card');
        const itemId = card.getAttribute('data-item-id');
        const user = auth.currentUser;
        if (user) {
          // 因为库存是共享的，需遍历所有路径查找该itemId
          const inventoryPaths = getInventoryPaths();
          let found = false;

          inventoryPaths.forEach(path => {
            if (found) return;
            const itemRef = db.ref(`${path}/${itemId}`);
            itemRef.once('value', (snapshot) => {
              const item = snapshot.val();
              if (item && !found) {
                found = true;
                openEditModal(itemId, item.type, item.name, item.category, item.quantity, item.unit, item.expiredDate, item.location);
              }
            });
          });
        }
      }
    });

    // 保存出货操作
    confirmStockOutButton.addEventListener('click', () => {
      const quantityToOut = stockOutQuantityInput.value.trim();
      const comment = stockOutCommentInput.value.trim();

      // 基本验证
      if (quantityToOut === '' || isNaN(quantityToOut) || Number(quantityToOut) <= 0) {
        stockOutError.textContent = '请填写有效的出货数量，且数量必须大于0';
        return;
      }

      const quantityNumber = Number(quantityToOut);

      const user = auth.currentUser;
      if (!user) {
        stockOutError.textContent = '用户未认证';
        return;
      }

      showLoading();

      // 查找当前库存项所在路径
      const inventoryPaths = getInventoryPaths();
      let itemFound = false;

      inventoryPaths.forEach(path => {
        if (itemFound) return;

        const itemRef = db.ref(`${path}/${currentStockOutItemId}`);
        itemRef.once('value', (snapshot) => {
          const item = snapshot.val();
          if (item && item.quantity >= quantityNumber) {
            itemFound = true;
            const newQuantity = item.quantity - quantityNumber;

            // 更新库存数量
            itemRef.update({
              quantity: newQuantity,
              modifiedTime: new Date().toISOString(), // 修改为 ISO 8601 格式
              modifiedBy: user.displayName || '未知'
            }, (error) => {
              if (error) {
                stockOutError.textContent = '出货失败: ' + error.message;
                hideLoading();
              } else {
                // 记录交易
                const transactionData = {
                  type: 'stock-out',
                  productName: item.name,
                  category: item.category || 'N/A',
                  quantity: quantityNumber,
                  unit: item.unit || 'N/A',
                  location: item.location,
                  time: new Date().toISOString(), // 修改为 ISO 8601 格式
                  user: user.displayName || '未知',
                  comment: comment || '无'
                };
                db.ref('transactions').push(transactionData)
                  .then(() => {
                    stockOutError.textContent = '';
                    stockOutModal.style.display = 'none';
                  })
                  .catch((error) => {
                    stockOutError.textContent = '记录交易失败: ' + error.message;
                  })
                  .finally(() => {
                    hideLoading();
                  });
              }
            });
          } else if (item && item.quantity < quantityNumber) {
            stockOutError.textContent = '出货数量超过库存数量';
            hideLoading();
          }
        });
      });

      // 如果未找到库存项
      setTimeout(() => {
        if (!itemFound) {
          stockOutError.textContent = '未找到对应的库存项或出货数量无效';
          hideLoading();
        }
      }, 1000);
    });

    // 显示指定的页面部分，并隐藏其他部分
    function showSection(section) {
      inventoryListSection.style.display = 'none';
      stockInOfficeSection.style.display = 'none';
      stockInKepayanSeafoodSection.style.display = 'none';
      stockInKepayanPackagedSection.style.display = 'none';
      transactionRecordsSection.style.display = 'none'; // 新增
      
      switch(section) {
        case 'inventory':
          inventoryListSection.style.display = 'block';
          break;
        case 'stock-in-office':
          stockInOfficeSection.style.display = 'block';
          break;
        case 'stock-in-kepayan-seafood':
          stockInKepayanSeafoodSection.style.display = 'block';
          break;
        case 'stock-in-kepayan-packaged':
          stockInKepayanPackagedSection.style.display = 'block';
          break;
        case 'transaction-records': // 新增
          transactionRecordsSection.style.display = 'block';
          loadTransactionRecords(); // 加载交易记录
          break;
        default:
          inventoryListSection.style.display = 'block';
      }
    }

    // 添加导航链接的事件处理
    navInventory.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('inventory');
    });

    navStockInOffice.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-in-office');
    });

    navStockInKepayanSeafood.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-in-kepayan-seafood');
    });

    navStockInKepayanPackaged.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-in-kepayan-packaged');
    });

    navTransactionRecords.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('transaction-records');
    });

    // 辅助函数：填充<select>选项（如果需要，可保留）
    function populateSelectOptions(selectElement, data, category, role, locationFilter) {
      // 清空现有选项，保留第一个"选择产品"选项
      selectElement.innerHTML = '<option value="">选择产品</option>';
      
      if (data) {
        let items = Object.keys(data)
          .filter(key => {
            if (category && data[key].category !== category) return false;
            if (locationFilter && data[key].location !== locationFilter) return false;
            if (data[key].type === 'stock-out') return false; // 只显示进货类型
            return data[key].quantity > 0;
          })
          .map(key => data[key].name);

        // 移除重复的产品名称
        const uniqueItems = [...new Set(items)];

        uniqueItems.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          selectElement.appendChild(option);
        });
      }
    }

    // 加载进出货记录
    function loadTransactionRecords() {
      showLoading();
      db.ref('transactions').orderByChild('time').once('value')
        .then((snapshot) => {
          const data = snapshot.val();
          transactionRecordsTableBody.innerHTML = ''; // 清空表格

          if (data) {
            // 将记录按时间降序排序
            const records = Object.values(data).sort((a, b) => new Date(b.time) - new Date(a.time));

            records.forEach(record => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${record.productName}</td>
                <td>${record.category || 'N/A'}</td>
                <td>${record.quantity}</td>
                <td>${record.unit}</td>
                <td>${record.location}</td>
                <td>${formatDateTime(record.time)}</td>
                <td>${record.user}</td>
                <td>${record.comment || '无'}</td>
              `;
              transactionRecordsTableBody.appendChild(tr);
            });
            transactionRecordsMessage.textContent = '';
          } else {
            transactionRecordsMessage.textContent = '暂无进出货记录';
          }
        })
        .catch((error) => {
          console.error('加载进出货记录失败:', error);
          transactionRecordsMessage.textContent = '加载进出货记录失败: ' + error.message;
        })
        .finally(() => {
          hideLoading();
        });
    }

    // 显示加载指示器
    function showLoading() {
      loadingIndicator.style.display = 'block';
    }

    // 隐藏加载指示器
    function hideLoading() {
      loadingIndicator.style.display = 'none';
    }

    // 根据角色判断是否可以执行特定操作
    function canPerformAction(action, location) {
      switch(userRole) {
        case 'admin':
          return true;
        case 'adminv':
          return action === 'view'; // adminv 只能查看
        case 'admino':
          return (action === 'view' || action === 'stock-in' || action === 'stock-out') && location === 'office';
        case 'admink':
          return (action === 'view' || action === 'stock-in' || action === 'stock-out') && location === 'kepayan';
        case 'user':
          return action === 'view'; // user 只能查看库存列表，但由于UI隐藏了，实际上什么都做不到
        default:
          return false;
      }
    }

    // 在执行进货、出货、编辑操作前调用此函数进行权限检查
    function performAction(action, location, callback) {
      if (canPerformAction(action, location)) {
        callback();
      } else {
        alert('您没有权限进行此操作');
      }
    }
</script>

</body>
</html>
